# çŸ¥è¯†åº“ç®¡ç†æŒ‡å—

## æ¦‚è¿°

CropPilotç³»ç»Ÿé‡‡ç”¨JSONæ–‡ä»¶ + ç¡¬ç¼–ç å…œåº•çš„æ··åˆçŸ¥è¯†ç®¡ç†æ–¹æ¡ˆï¼Œç»“åˆChromaDBå‘é‡æ•°æ®åº“å®ç°æ™ºèƒ½è¯­ä¹‰æœç´¢ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„çµæ´»æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ç³»ç»Ÿæ¶æ„

### çŸ¥è¯†ç®¡ç†æ¶æ„å›¾

```mermaid
graph TB
    subgraph "æ•°æ®æºå±‚"
        A[JSONæ–‡ä»¶]
        B[CSVæ–‡ä»¶]
        C[æ•°æ®åº“]
        D[ç¡¬ç¼–ç å…œåº•]
    end
    
    subgraph "åŠ è½½å±‚"
        E[KnowledgeLoader]
    end
    
    subgraph "å¤„ç†å±‚"
        F[SmartKnowledgeBase]
        G[sentence-transformers]
    end
    
    subgraph "å­˜å‚¨å±‚"
        H[ChromaDBå‘é‡åº“]
        I[æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ]
    end
    
    subgraph "åº”ç”¨å±‚"
        J[å†³ç­–å¼•æ“]
        K[APIæ¥å£]
        L[ç®¡ç†å·¥å…·]
    end
    
    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    G --> H
    F --> I
    H --> J
    J --> K
    E --> L
```

### æ ¸å¿ƒç»„ä»¶

1. **KnowledgeLoader**: å¤šæ•°æ®æºçŸ¥è¯†åŠ è½½å™¨
2. **SmartKnowledgeBase**: æ™ºèƒ½çŸ¥è¯†åº“æ ¸å¿ƒ
3. **ChromaDB**: å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒè¯­ä¹‰æœç´¢
4. **sentence-transformers**: æ–‡æœ¬å‘é‡åŒ–æ¨¡å‹

## JSONçŸ¥è¯†åº“æ ¼å¼

### æ ‡å‡†æ ¼å¼

```json
{
  "knowledge_base": {
    "version": "1.0",
    "last_updated": "2025-12-20T15:06:37.678316",
    "documents": [
      {
        "id": "unique_document_id",
        "content": "çŸ¥è¯†å†…å®¹æ–‡æœ¬",
        "source": "çŸ¥è¯†æ¥æº",
        "crop": "é€‚ç”¨ä½œç‰©",
        "stage": "ç”Ÿé•¿é˜¶æ®µ",
        "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
        "priority": 1,
        "active": true
      }
    ]
  }
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| id | string | æ˜¯ | æ–‡æ¡£å”¯ä¸€æ ‡è¯†ç¬¦ |
| content | string | æ˜¯ | çŸ¥è¯†å†…å®¹ï¼Œç”¨äºå‘é‡åŒ–å’Œæœç´¢ |
| source | string | æ˜¯ | çŸ¥è¯†æ¥æºï¼Œå¦‚"å†œä¸šæŠ€æœ¯æ‰‹å†Œ" |
| crop | string | å¦ | é€‚ç”¨ä½œç‰©ï¼Œé»˜è®¤"é€šç”¨" |
| stage | string | å¦ | ç”Ÿé•¿é˜¶æ®µï¼Œé»˜è®¤"é€šç”¨" |
| keywords | array | å¦ | å…³é”®è¯åˆ—è¡¨ï¼Œç”¨äºè¾…åŠ©æœç´¢ |
| priority | integer | å¦ | ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ |
| active | boolean | å¦ | æ˜¯å¦å¯ç”¨ï¼Œé»˜è®¤true |

## ç®¡ç†å·¥å…·ä½¿ç”¨

### 1. äº¤äº’å¼ç®¡ç†å·¥å…·

```bash
python manage_knowledge.py
```

**åŠŸèƒ½èœå•**ï¼š
- æŸ¥çœ‹æ‰€æœ‰çŸ¥è¯†
- æ·»åŠ æ–°çŸ¥è¯†
- æœç´¢çŸ¥è¯†
- ç¦ç”¨/å¯ç”¨çŸ¥è¯†
- é€€å‡º

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```
ğŸŒ¾ å†œä¸šçŸ¥è¯†åº“ç®¡ç†å·¥å…·
1. æŸ¥çœ‹æ‰€æœ‰çŸ¥è¯†
2. æ·»åŠ æ–°çŸ¥è¯†
3. æœç´¢çŸ¥è¯†
4. ç¦ç”¨çŸ¥è¯†
5. å¯ç”¨çŸ¥è¯†
0. é€€å‡º

è¯·é€‰æ‹©æ“ä½œ (0-5): 2

ğŸ“ æ·»åŠ æ–°çŸ¥è¯†:
çŸ¥è¯†å†…å®¹: å°éº¦æ’­ç§æœŸè¦é€‰æ‹©é€‚å®œçš„æ’­ç§æ—¶é—´ï¼Œä¸€èˆ¬åœ¨10æœˆä¸­ä¸‹æ—¬
çŸ¥è¯†æ¥æº: å°éº¦æ ½åŸ¹æŠ€æœ¯è§„ç¨‹
é€‚ç”¨ä½œç‰© (é»˜è®¤:é€šç”¨): å°éº¦
ç”Ÿé•¿é˜¶æ®µ (é»˜è®¤:é€šç”¨): æ’­ç§æœŸ
å…³é”®è¯ (ç”¨é€—å·åˆ†éš”): å°éº¦,æ’­ç§,æ—¶é—´
ä¼˜å…ˆçº§ (1-5, é»˜è®¤:1): 1

âœ… æˆåŠŸæ·»åŠ çŸ¥è¯†æ¡ç›®: kb_20251220_150637
```

### 2. æ¼”ç¤ºè„šæœ¬

```bash
python demo_knowledge_management.py
```

å±•ç¤ºçŸ¥è¯†ç®¡ç†çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- åŠ è½½ç°æœ‰çŸ¥è¯†
- æ·»åŠ æ–°çŸ¥è¯†
- é‡ç½®å‘é‡æ•°æ®åº“
- æµ‹è¯•æ–°çŸ¥è¯†æ£€ç´¢

### 3. å‘é‡æ•°æ®åº“é‡ç½®

```bash
python reset_knowledge_db.py
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ›´æ–°JSONæ–‡ä»¶å
- å‘é‡æ•°æ®åº“æŸå
- éœ€è¦é‡æ–°æ„å»ºç´¢å¼•

## æ•°æ®æºé…ç½®

### 1. JSONæ–‡ä»¶æ•°æ®æºï¼ˆæ¨èï¼‰

```python
from smart_knowledge import SmartKnowledgeBase

# ä½¿ç”¨é»˜è®¤JSONæ–‡ä»¶
kb = SmartKnowledgeBase(data_source="json")

# ä½¿ç”¨è‡ªå®šä¹‰JSONæ–‡ä»¶
kb = SmartKnowledgeBase(
    data_source="json", 
    data_path="data/custom_knowledge.json"
)
```

### 2. CSVæ–‡ä»¶æ•°æ®æº

```python
kb = SmartKnowledgeBase(
    data_source="csv", 
    data_path="data/knowledge.csv"
)
```

**CSVæ ¼å¼è¦æ±‚**ï¼š
```csv
id,content,source,crop,stage,keywords,priority,active
doc1,"çŸ¥è¯†å†…å®¹","æ¥æº","ä½œç‰©","é˜¶æ®µ","å…³é”®è¯1,å…³é”®è¯2",1,true
```

### 3. æ•°æ®åº“æ•°æ®æº

```python
# éœ€è¦ä¼ å…¥æ•°æ®åº“è¿æ¥
kb = SmartKnowledgeBase(data_source="database")
```

### 4. ç¡¬ç¼–ç å…œåº•

å½“å…¶ä»–æ•°æ®æºä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨ç¡¬ç¼–ç çš„æœ€å°çŸ¥è¯†é›†åˆï¼Œç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¯ç”¨ã€‚

## APIé›†æˆ

### æ™ºèƒ½å’¨è¯¢æ¥å£

```python
# ç›´æ¥è°ƒç”¨
from smart_knowledge import smart_query

result = smart_query(
    question="æ°´ç¨»å¶å­å‘é»„æ€ä¹ˆåŠ",
    crop_type="æ°´ç¨»",
    growth_stage="åˆ†è˜–æœŸ"
)
```

### REST APIè°ƒç”¨

```bash
curl -X POST http://localhost:5000/api/smart_advice \
  -H "Content-Type: application/json" \
  -d '{
    "question": "æ°´ç¨»å¶å­å‘é»„æ€ä¹ˆåŠ",
    "crop_type": "æ°´ç¨»", 
    "growth_stage": "åˆ†è˜–æœŸ"
  }'
```

## æœ€ä½³å®è·µ

### 1. çŸ¥è¯†å†…å®¹ç¼–å†™

**å¥½çš„çŸ¥è¯†å†…å®¹**ï¼š
```json
{
  "content": "æ°´ç¨»åˆ†è˜–æœŸæ˜¯æ°´ç¨»ç”Ÿé•¿çš„å…³é”®æ—¶æœŸï¼Œæ­¤æ—¶éœ€è¦ä¿æŒæµ…æ°´å±‚3-5cmï¼Œä¿ƒè¿›åˆ†è˜–ã€‚æ–½è‚¥æ–¹é¢ï¼Œæ¯äº©è¿½æ–½å°¿ç´ 5-8å…¬æ–¤ï¼Œä¿ƒè¿›åˆ†è˜–å‘ç”Ÿã€‚æ³¨æ„é˜²æ²»ç¨»é£è™±å’Œçº¹æ¯ç—…ã€‚",
  "source": "æ°´ç¨»æ ½åŸ¹æŠ€æœ¯æ‰‹å†Œ",
  "crop": "æ°´ç¨»",
  "stage": "åˆ†è˜–æœŸ"
}
```

**ç‰¹ç‚¹**ï¼š
- å†…å®¹å…·ä½“è¯¦ç»†
- åŒ…å«å…·ä½“æ•°å€¼å’Œæ“ä½œæŒ‡å¯¼
- æ˜ç¡®é€‚ç”¨æ¡ä»¶

### 2. å…³é”®è¯è®¾ç½®

```json
{
  "keywords": ["åˆ†è˜–", "æµ…æ°´å±‚", "å°¿ç´ ", "ç¨»é£è™±", "çº¹æ¯ç—…"]
}
```

**åŸåˆ™**ï¼š
- åŒ…å«æ ¸å¿ƒæŠ€æœ¯æœ¯è¯­
- æ¶µç›–é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆå…³é”®è¯
- é¿å…è¿‡äºé€šç”¨çš„è¯æ±‡

### 3. ä¼˜å…ˆçº§è®¾ç½®

| ä¼˜å…ˆçº§ | ç”¨é€” | ç¤ºä¾‹ |
|--------|------|------|
| 1 | æ ¸å¿ƒæŠ€æœ¯çŸ¥è¯† | ä½œç‰©æ ½åŸ¹æŠ€æœ¯è¦ç‚¹ |
| 2 | é€šç”¨ç®¡ç†çŸ¥è¯† | ç—…è™«å®³é˜²æ²»åŸåˆ™ |
| 3 | è¡¥å……å‚è€ƒçŸ¥è¯† | ç›¸å…³èƒŒæ™¯ä¿¡æ¯ |

### 4. ç‰ˆæœ¬ç®¡ç†

```json
{
  "knowledge_base": {
    "version": "1.1",
    "last_updated": "2025-12-20T15:06:37.678316",
    "changelog": [
      "v1.1: æ·»åŠ å°éº¦æ ½åŸ¹çŸ¥è¯†",
      "v1.0: åˆå§‹ç‰ˆæœ¬"
    ]
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å‘é‡æ•°æ®åº“ä¼˜åŒ–

- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ·»åŠ æ–‡æ¡£æé«˜æ•ˆç‡
- **ç´¢å¼•ä¼˜åŒ–**: å®šæœŸé‡å»ºç´¢å¼•ä¿æŒæ€§èƒ½
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ

### 2. æŸ¥è¯¢ä¼˜åŒ–

```python
# ä¼˜åŒ–æŸ¥è¯¢å‚æ•°
results = kb.query(
    question="å¶å­å‘é»„",
    crop_type="æ°´ç¨»",
    growth_stage="åˆ†è˜–æœŸ",
    n_results=3  # é™åˆ¶ç»“æœæ•°é‡
)
```

### 3. å†…å­˜ç®¡ç†

- ä½¿ç”¨å•ä¾‹æ¨¡å¼é¿å…é‡å¤åˆå§‹åŒ–
- åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„æ¨¡å‹èµ„æº
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. å‘é‡æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥**
```bash
# è§£å†³æ–¹æ¡ˆï¼šé‡ç½®æ•°æ®åº“
python reset_knowledge_db.py
```

**2. æ¨¡å‹ä¸‹è½½å¤±è´¥**
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œé‡æ–°å®‰è£…
pip uninstall sentence-transformers
pip install sentence-transformers
```

**3. JSONæ–‡ä»¶æ ¼å¼é”™è¯¯**
```bash
# è§£å†³æ–¹æ¡ˆï¼šéªŒè¯JSONæ ¼å¼
python -m json.tool data/agriculture_knowledge.json
```

**4. æœç´¢ç»“æœä¸å‡†ç¡®**
- æ£€æŸ¥å…³é”®è¯è®¾ç½®
- è°ƒæ•´ç›¸å…³æ€§é˜ˆå€¼
- ä¼˜åŒ–çŸ¥è¯†å†…å®¹æè¿°

### æ—¥å¿—åˆ†æ

ç³»ç»Ÿä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼š
```
æ™ºèƒ½çŸ¥è¯†åº“åˆå§‹åŒ–æˆåŠŸ
ä» agriculture_knowledge.json åŠ è½½äº† 11 æ¡çŸ¥è¯†
æˆåŠŸåˆå§‹åŒ– 11 æ¡å†œä¸šçŸ¥è¯†
```

## æ‰©å±•å¼€å‘

### 1. è‡ªå®šä¹‰æ•°æ®æº

```python
class CustomKnowledgeLoader(KnowledgeLoader):
    def load_from_api(self, api_url: str) -> List[Dict[str, Any]]:
        """ä»APIåŠ è½½çŸ¥è¯†"""
        # å®ç°APIæ•°æ®åŠ è½½é€»è¾‘
        pass
```

### 2. è‡ªå®šä¹‰å‘é‡æ¨¡å‹

```python
# ä½¿ç”¨ä¸åŒçš„å‘é‡æ¨¡å‹
kb = SmartKnowledgeBase()
kb.model = SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')
```

### 3. çŸ¥è¯†è´¨é‡è¯„ä¼°

```python
def evaluate_knowledge_quality(knowledge_docs):
    """è¯„ä¼°çŸ¥è¯†è´¨é‡"""
    for doc in knowledge_docs:
        # æ£€æŸ¥å†…å®¹é•¿åº¦
        # éªŒè¯å…³é”®è¯è¦†ç›–
        # è¯„ä¼°è¯­ä¹‰ç›¸å…³æ€§
        pass
```

è¿™ä¸ªçŸ¥è¯†ç®¡ç†ç³»ç»Ÿä¸ºCropPilotæä¾›äº†çµæ´»ã€å¯é ã€æ˜“ç”¨çš„çŸ¥è¯†ç®¡ç†èƒ½åŠ›ï¼Œæ”¯æŒç³»ç»Ÿçš„æŒç»­æ”¹è¿›å’Œæ‰©å±•ã€‚