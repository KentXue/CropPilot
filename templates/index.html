<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œç‰©ç”Ÿé•¿çŠ¶æ€ç®¡ç†ä¸å†³ç­–æ”¯æŒç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    h2, h3 {
      color: #555;
      margin: 20px 0 15px 0;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .form-group {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    label {
      min-width: 100px;
      font-weight: bold;
      color: #333;
    }
    select, input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      flex: 1;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result-box {
      border: 2px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      background: white;
      min-height: 100px;
      margin-top: 15px;
    }
    .advice-item {
      padding: 10px;
      margin: 8px 0;
      background: #e8f4f8;
      border-left: 3px solid #667eea;
      border-radius: 4px;
    }
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .sensor-input {
      display: flex;
      flex-direction: column;
    }
    .sensor-input label {
      min-width: auto;
      margin-bottom: 5px;
      font-size: 13px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: none;
      border: none;
      color: #666;
      font-size: 16px;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      color: #2e7d32;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ¾ ä½œç‰©ç”Ÿé•¿çŠ¶æ€ç®¡ç†ä¸å†³ç­–æ”¯æŒç³»ç»Ÿ</h1>
    
    <div class="section" style="margin-top:10px;">
      <h3>ğŸ‘¤ é€‰æ‹©ç”¨æˆ·ï¼ˆæ¼”ç¤ºç”¨ï¼‰</h3>
      <div class="form-group">
        <label>ç”¨æˆ·ï¼š</label>
        <select id="userSelect">
          <option value="">å…¨éƒ¨ç”¨æˆ·</option>
        </select>
        <small style="color:#777;">é€‰æ‹©ç”¨æˆ·åå°†åªæ˜¾ç¤ºå…¶åœ°å—</small>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('advice')">å†œäº‹å»ºè®®</button>
      <button class="tab" onclick="switchTab('sensor')">ä¼ æ„Ÿå™¨æ•°æ®</button>
      <button class="tab" onclick="switchTab('history')">å†å²è®°å½•</button>
    </div>

    <!-- å†œäº‹å»ºè®®æ ‡ç­¾é¡µ -->
    <div id="advice-tab" class="tab-content active">
      <div class="section">
        <h2>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åœ°å— / ä½œç‰© / ç”Ÿé•¿é˜¶æ®µ</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="fieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
          <small style="color:#777;">(æ¨è) é€‰æ‹©åœ°å—åè‡ªåŠ¨å¸¦å‡ºä½œç‰©</small>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="cropSelect">
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="stageSelect">
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
          
          <button onclick="getAdvice()">è·å–å†œäº‹å»ºè®®</button>
        </div>
      </div>
      
      <div class="section">
        <h3>ğŸ’¡ ç³»ç»Ÿå»ºè®®</h3>
        <div id="adviceResult" class="result-box">
          <p style="color: #999;">å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>
    </div>

    <!-- ä¼ æ„Ÿå™¨æ•°æ®æ ‡ç­¾é¡µ -->
    <div id="sensor-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“Š å½•å…¥ä¼ æ„Ÿå™¨æ•°æ®</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="sensorFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="sensorCropSelect">
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="sensorStageSelect">
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
        </div>

        <div class="section" style="background: #fff; border-left-color: #28a745; border: 1px solid #e5e5e5; margin-top: 10px;">
          <h3>ğŸ–¼ ä¸Šä¼ ä½œç‰©å›¾ç‰‡</h3>
          <p style="color:#777; margin-bottom:10px;">å…ˆé€‰æ‹©ä¸Šæ–¹åœ°å—ï¼Œå†ä¸Šä¼ å›¾ç‰‡ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°ç³»ç»Ÿå¹¶è®°å½•è·¯å¾„ä¸æ—¶é—´ï¼‰ã€‚</p>
          <div class="form-group">
            <label>æ‹æ‘„æ—¶é—´ï¼š</label>
            <input type="datetime-local" id="capturedAt">
          </div>
          <div class="form-group">
            <label>ä½œç‰©å›¾ç‰‡ï¼š</label>
            <input type="file" id="cropImageFile" accept="image/*" style="flex:1;">
            <button onclick="uploadCropImage()" style="margin-left:10px;">ä¸Šä¼ ä½œç‰©å›¾ç‰‡</button>
          </div>
          <div id="uploadResult"></div>
        </div>
        
        <div class="sensor-grid">
          <div class="sensor-input">
            <label>æ¸©åº¦ (Â°C):</label>
            <input type="number" id="temperature" step="0.1" placeholder="ä¾‹å¦‚: 25.5">
          </div>
          <div class="sensor-input">
            <label>æ¹¿åº¦ (%):</label>
            <input type="number" id="humidity" step="0.1" placeholder="ä¾‹å¦‚: 65.0">
          </div>
          <div class="sensor-input">
            <label>åœŸå£¤æ¹¿åº¦ (%):</label>
            <input type="number" id="soilMoisture" step="0.1" placeholder="ä¾‹å¦‚: 70.0">
          </div>
          <div class="sensor-input">
            <label>å…‰ç…§å¼ºåº¦ (lux):</label>
            <input type="number" id="lightIntensity" step="0.1" placeholder="ä¾‹å¦‚: 50000">
          </div>
          <div class="sensor-input">
            <label>pHå€¼:</label>
            <input type="number" id="phValue" step="0.1" placeholder="ä¾‹å¦‚: 6.5">
          </div>
          <div class="sensor-input">
            <label>æ°®å«é‡ (mg/kg):</label>
            <input type="number" id="nitrogen" step="0.1" placeholder="ä¾‹å¦‚: 150.0">
          </div>
          <div class="sensor-input">
            <label>ç£·å«é‡ (mg/kg):</label>
            <input type="number" id="phosphorus" step="0.1" placeholder="ä¾‹å¦‚: 80.0">
          </div>
          <div class="sensor-input">
            <label>é’¾å«é‡ (mg/kg):</label>
            <input type="number" id="potassium" step="0.1" placeholder="ä¾‹å¦‚: 120.0">
          </div>
          <div class="sensor-input">
            <label>ä½ç½®/åœ°å—:</label>
            <input type="text" id="location" placeholder="ä¾‹å¦‚: AåŒº-1å·ç”°">
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <button onclick="saveSensorData()">ä¿å­˜ä¼ æ„Ÿå™¨æ•°æ®</button>
          <button onclick="getAdviceWithSensor()" style="background: #28a745; margin-left: 10px;">åŸºäºæ•°æ®è·å–å»ºè®®</button>
        </div>
        
        <div id="sensorResult"></div>
      </div>
    </div>

    <!-- å†å²è®°å½•æ ‡ç­¾é¡µ -->
    <div id="history-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“œ æŸ¥è¯¢å†å²è®°å½•</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="historyFieldSelect">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="historyCropSelect">
            <option value="">å…¨éƒ¨</option>
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="historyStageSelect">
            <option value="">å…¨éƒ¨</option>
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
          
          <button onclick="loadHistory()">æŸ¥è¯¢å†å²</button>
        </div>
        
        <div id="historyResult" class="result-box">
          <p style="color: #999;">å†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç®€å•çš„ç¼“å­˜
    let usersCache = [];
    let fieldsCache = [];

    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(data => {
          if (data.status !== 'success') return;
          usersCache = data.users || [];
          const sel = document.getElementById('userSelect');
          if (sel) {
            const firstOption = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(firstOption);
            usersCache.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.id;
              opt.textContent = `${u.username} (${u.role})`;
              sel.appendChild(opt);
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·å¹¶åŠ è½½å…¶åœ°å—
            if (usersCache.length > 0) {
              sel.value = usersCache[0].id;
              loadFields(usersCache[0].id);
            } else {
              loadFields();
            }
          }
        })
        .catch(err => console.error('åŠ è½½ç”¨æˆ·å¤±è´¥', err));
    }

    function loadFields(userId) {
      let url = '/api/fields';
      if (userId) {
        const params = new URLSearchParams();
        params.append('user_id', userId);
        url += `?${params.toString()}`;
      }
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.status !== 'success') return;
          fieldsCache = data.fields || [];
          const fieldSelectIds = ['fieldSelect', 'sensorFieldSelect', 'historyFieldSelect'];
          fieldSelectIds.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            // å…ˆä¿ç•™ç¬¬ä¸€ä¸ªå ä½é¡¹
            const firstOption = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(firstOption);
            // å¦‚æœåˆ‡æ¢ç”¨æˆ·ï¼Œåˆ™é‡ç½®é€‰ä¸­é¡¹ä¸ºç©º
            sel.value = '';
            fieldsCache.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f.id;
              opt.textContent = `${f.name} (${f.crop_type})`;
              sel.appendChild(opt);
            });
          });
        })
        .catch(err => console.error('åŠ è½½åœ°å—å¤±è´¥', err));
    }

    function getFieldById(fieldId) {
      return fieldsCache.find(f => String(f.id) === String(fieldId));
    }

    function switchTab(tabName) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„activeç±»
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
      });
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      document.getElementById(tabName + '-tab').classList.add('active');
      // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
      event.target.classList.add('active');
    }

    function getAdvice() {
      const fieldId = document.getElementById('fieldSelect').value;
      const crop = document.getElementById('cropSelect').value;
      const stage = document.getElementById('stageSelect').value;
      
      document.getElementById('adviceResult').innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';

      const params = new URLSearchParams();
      if (fieldId) params.append('field_id', fieldId);
      params.append('crop', crop);
      params.append('stage', stage);
      
      fetch(`/api/get_advice?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            let html = `<p style="font-size: 18px; margin-bottom: 15px;"><strong>${data.crop} - ${data.stage}</strong></p>`;
            if (data.advice && data.advice.length > 0) {
              data.advice.forEach(item => {
                html += `<div class="advice-item">${item}</div>`;
              });
            } else {
              html += '<p>æš‚æ— å»ºè®®</p>';
            }
            document.getElementById('adviceResult').innerHTML = html;
          } else {
            document.getElementById('adviceResult').innerHTML = '<div class="error">è·å–å»ºè®®å¤±è´¥</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('adviceResult').innerHTML = '<div class="error">è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ã€‚</div>';
        });
    }

    function uploadCropImage() {
      const fieldId = document.getElementById('sensorFieldSelect').value;
      const uploadResult = document.getElementById('uploadResult');
      const fileInput = document.getElementById('cropImageFile');
      const capturedAt = document.getElementById('capturedAt').value;

      if (!fieldId) {
        uploadResult.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©åœ°å—</div>';
        return;
      }

      if (!fileInput || fileInput.files.length === 0) {
        uploadResult.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡</div>';
        return;
      }

      const formData = new FormData();
      formData.append('field_id', fieldId);
      formData.append('image', fileInput.files[0]);
      if (capturedAt) {
        formData.append('captured_at', capturedAt);
      }

      uploadResult.innerHTML = '<p>æ­£åœ¨ä¸Šä¼ ...</p>';

      fetch('/api/upload_crop_image', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const link = data.image_path ? `<a href="${data.image_path}" target="_blank">æŸ¥çœ‹å›¾ç‰‡</a>` : '';
            uploadResult.innerHTML = `<div class="success">ä¸Šä¼ æˆåŠŸï¼${link}</div>`;
            fileInput.value = '';
          } else {
            uploadResult.innerHTML = `<div class="error">ä¸Šä¼ å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          uploadResult.innerHTML = '<div class="error">ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•ã€‚</div>';
        });
    }

    function saveSensorData() {
      const fieldId = document.getElementById('sensorFieldSelect').value;
      if (!fieldId) {
        document.getElementById('sensorResult').innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©åœ°å—</div>';
        return;
      }

      const data = {
        field_id: parseInt(fieldId),
        crop_type: document.getElementById('sensorCropSelect').value,
        growth_stage: document.getElementById('sensorStageSelect').value,
        temperature: document.getElementById('temperature').value || null,
        humidity: document.getElementById('humidity').value || null,
        soil_moisture: document.getElementById('soilMoisture').value || null,
        light_intensity: document.getElementById('lightIntensity').value || null,
        ph_value: document.getElementById('phValue').value || null,
        nitrogen: document.getElementById('nitrogen').value || null,
        phosphorus: document.getElementById('phosphorus').value || null,
        potassium: document.getElementById('potassium').value || null,
        location: document.getElementById('location').value || null
      };

      fetch('/api/save_sensor_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.status === 'success') {
            document.getElementById('sensorResult').innerHTML = 
              '<div class="success">ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜æˆåŠŸï¼ID: ' + result.data_id + '</div>';
          } else {
            document.getElementById('sensorResult').innerHTML = 
              '<div class="error">ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('sensorResult').innerHTML = 
            '<div class="error">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</div>';
        });
    }

    function getAdviceWithSensor() {
      // å…ˆä¿å­˜æ•°æ®ï¼Œç„¶åç›´æ¥è·å–å½“å‰ä½œç‰©+é˜¶æ®µçš„å»ºè®®
      saveSensorData();
      getAdvice();
    }

    function loadHistory() {
      const fieldId = document.getElementById('historyFieldSelect').value;
      const crop = document.getElementById('historyCropSelect').value;
      const stage = document.getElementById('historyStageSelect').value;
      
      let url = '/api/get_history';
      const params = new URLSearchParams();
      if (fieldId) params.append('field_id', fieldId);
      if (crop) params.append('crop', crop);
      if (stage) params.append('stage', stage);
      if (params.toString()) url += '?' + params.toString();
      
      document.getElementById('historyResult').innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            let html = '<h3>å†³ç­–è®°å½• (' + data.count + ' æ¡)</h3>';
            if (data.records && data.records.length > 0) {
              data.records.forEach(record => {
                html += `<div class="advice-item" style="margin-bottom: 15px;">`;
                html += `<p><strong>${record.crop_type} - ${record.growth_stage}</strong></p>`;
                html += `<p>${record.advice}</p>`;
                html += `<p style="color: #999; font-size: 12px;">${record.created_at}</p>`;
                html += `</div>`;
              });
            } else {
              html += '<p>æš‚æ— å†å²è®°å½•</p>';
            }
            document.getElementById('historyResult').innerHTML = html;
          } else {
            document.getElementById('historyResult').innerHTML = 
              '<div class="error">æŸ¥è¯¢å¤±è´¥</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('historyResult').innerHTML = 
            '<div class="error">è¯·æ±‚å¤±è´¥</div>';
        });
    }

    // é€‰åœ°å—æ—¶è‡ªåŠ¨å¸¦å‡ºä½œç‰©ç±»å‹
    document.addEventListener('change', (e) => {
      if (e.target.id === 'userSelect') {
        const userId = e.target.value;
        loadFields(userId);
        return;
      }
      if (e.target.id === 'fieldSelect' || e.target.id === 'sensorFieldSelect') {
        const fieldId = e.target.value;
        const field = getFieldById(fieldId);
        if (field) {
          if (e.target.id === 'fieldSelect') {
            document.getElementById('cropSelect').value = field.crop_type;
          }
          if (e.target.id === 'sensorFieldSelect') {
            document.getElementById('sensorCropSelect').value = field.crop_type;
          }
        }
      }
    });

    // é¡µé¢åŠ è½½æ—¶å…ˆæ‹‰å–ç”¨æˆ·ï¼Œå†åŠ è½½åœ°å—
    window.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</body>
</html>

