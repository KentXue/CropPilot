<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œç‰©ç”Ÿé•¿çŠ¶æ€ç®¡ç†ä¸å†³ç­–æ”¯æŒç³»ç»Ÿ</title>
  <!-- Chart.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* ç®€æ´é…è‰²æ–¹æ¡ˆ - åªä½¿ç”¨3ä¸ªä¸»è¦é¢œè‰² */
      --primary-color: #2E7D32;      /* ä¸»ç»¿è‰² - å†œä¸šä¸»é¢˜ */
      --accent-color: #FFA726;       /* æ©™é»„è‰² - å¼ºè°ƒè‰² */
      --background-color: #ffffff;   /* ç™½è‰²èƒŒæ™¯ */
      
      /* æ–‡å­—é¢œè‰² */
      --text-primary: #2c2c2c;       /* æ·±ç°è‰²æ–‡å­— */
      --text-secondary: #666666;     /* ä¸­ç°è‰²æ–‡å­— */
      --text-light: #ffffff;         /* ç™½è‰²æ–‡å­— */
      
      /* ä¸­æ€§è‰² */
      --border-color: #e0e0e0;       /* è¾¹æ¡†é¢œè‰² */
      --hover-color: #f5f5f5;        /* æ‚¬åœèƒŒæ™¯ */
      --disabled-color: #cccccc;     /* ç¦ç”¨çŠ¶æ€ */
      
      /* é˜´å½±å’Œåœ†è§’ä¿æŒä¸å˜ */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.15);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.15);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.2), 0 8px 10px -6px rgb(0 0 0 / 0.15);
      
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 14px;
      padding: 1rem;
    }
    
    .container {
      max-width: 1440px;
      margin: 0 auto;
      background: var(--background-color);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
      overflow: hidden;
      position: relative;
    }
    
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary-color);
    }
    .header {
      padding: 2rem 2.5rem 1rem;
      text-align: center;
      background: var(--primary-color);
      border-bottom: none;
    }
    
    h1 {
      font-size: clamp(1.75rem, 4vw, 2.25rem);
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
    }
    
    .subtitle {
      color: var(--text-light) !important;
      font-size: 1rem;
      font-weight: 400;
      margin-bottom: 1.5rem;
      opacity: 0.9;
    }
    
    .main-content {
      padding: 0 2.5rem 2.5rem;
    }
    
    h2, h3 {
      color: var(--text-primary) !important;
      font-weight: 600;
      margin-bottom: 1rem;
      letter-spacing: -0.025em;
    }
    
    h2 {
      font-size: 1.25rem;
    }
    
    h3 {
      font-size: 1.125rem;
    }
    
    .section {
      margin-bottom: 2rem;
      background: var(--background-color);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      overflow: hidden;
    }
    
    .section:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-color);
    }
    
    .section-header {
      padding: 1.5rem 1.5rem 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      background: var(--hover-color);
    }
    
    .section-content {
      padding: 0 1.5rem 1.5rem;
    }
    
    .user-selector {
      background: var(--accent-color);
      border-radius: var(--radius-lg);
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }
    .form-group {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .form-group {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
    }
    
    label {
      font-weight: 500;
      color: var(--text-primary) !important;
      font-size: 0.875rem;
      min-width: 120px;
      white-space: nowrap;
    }
    
    select, input, textarea {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      flex: 1;
      transition: all 0.2s ease;
      background: var(--background-color);
      font-family: inherit;
      color: var(--text-primary);
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }
    
    select:hover, input:hover, textarea:hover {
      border-color: var(--primary-color);
    }
    
    input::placeholder, textarea::placeholder {
      color: #999999;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: var(--text-light);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--primary-color);
    }
    
    .btn-primary:hover {
      background: #1b5e20;
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #4caf50;
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-success:hover {
      background: #388e3c;
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--background-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background: var(--hover-color);
      border-color: var(--primary-color);
    }
    
    .btn:disabled {
      background: #f5f5f5;
      color: #999999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    /* Legacy button support */
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--primary-color);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    button:hover {
      background: #1b5e20;
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    button:disabled {
      background: var(--disabled-color);
      color: #999999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .result-box {
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      min-height: 120px;
      margin-top: 1rem;
    }
    
    .advice-item {
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .advice-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-sm);
    }
    
    .advice-item:last-child {
      margin-bottom: 0;
    }
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .sensor-input {
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      transition: all 0.2s ease;
    }
    
    .sensor-input:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-sm);
    }
    
    .sensor-input:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }
    
    .sensor-input label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    
    .sensor-input input {
      width: 100%;
      margin: 0;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      font-size: 0.875rem;
    }
    
    .sensor-input .unit {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      line-height: 1.4;
    }
    
    .sensor-input input.input-success {
      border-color: #4caf50;
      background: #e8f5e9;
    }
    
    .sensor-input input.input-warning {
      border-color: #ff9800;
      background: #fff8e1;
    }
    
    .sensor-input input.input-danger {
      border-color: #f44336;
      background: #ffebee;
    }
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      .container {
        margin: 0.5rem;
      }
      .main-content {
        padding: 0 1.5rem 1.5rem;
      }
      .header {
        padding: 1.5rem 1.5rem 1rem;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .container {
        border-radius: var(--radius-lg);
      }
      
      .header {
        padding: 1rem;
      }
      
      .main-content {
        padding: 0 1rem 1rem;
      }
      
      .tabs {
        flex-wrap: wrap;
        gap: 0.25rem;
      }
      
      .tab {
        flex: none;
        min-width: auto;
        padding: 0.625rem 1rem;
        font-size: 0.8125rem;
      }
      
      .sensor-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      .chart-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .form-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      label {
        min-width: auto;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 0.75rem;
      }
      
      .main-content {
        padding: 0 0.75rem 0.75rem;
      }
      
      .section-content {
        padding: 0 1rem 1rem;
      }
      
      .section-header {
        padding: 1rem 1rem 0;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .subtitle {
        font-size: 0.875rem;
      }
      
      .btn, button {
        padding: 0.625rem 1rem;
        font-size: 0.8125rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #F0B400;    /* é‡‘é»„è‰² - ä¸»èƒŒæ™¯ */
        --bg-secondary: #2A5200;  /* æ·±ç»¿è‰² - æ¬¡è¦èƒŒæ™¯ */
        --bg-accent1: #038056;    /* é’ç»¿è‰² - å¼ºè°ƒè‰²1 */
        --bg-accent2: #039688;    /* è“ç»¿è‰² - å¼ºè°ƒè‰²2 */
        --bg-light: #ffffff;     /* ç™½è‰² - æµ…è‰²èƒŒæ™¯ */
        
        --text-primary: #797979;  /* ä¸»æ–‡å­—é¢œè‰² */
        --text-light: #ffffff;    /* ç™½è‰²æ–‡å­— */
        --text-dark: #333333;     /* æ·±è‰²æ–‡å­— */
      }
      
      body {
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-accent1) 100%);
        color: var(--text-primary);
      }
      
      .container {
        background: var(--bg-light);
        border-color: var(--bg-accent2);
      }
    }
    
    /* æ‰“å°æ ·å¼ */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        border: none;
        border-radius: 0;
      }
      
      .tabs {
        display: none;
      }
      
      .tab-content {
        display: block !important;
      }
      
      .btn, button {
        display: none;
      }
    }
    
    /* é«˜å¯¹æ¯”åº¦æ¨¡å¼ */
    @media (prefers-contrast: high) {
      .container {
        border: 2px solid #222222;
      }
      
      .section {
        border: 1px solid #222222;
      }
      
      .btn, button {
        border: 2px solid currentColor;
      }
    }
    
    /* å‡å°‘åŠ¨ç”»æ¨¡å¼ */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* å¼ºåˆ¶æµ…è‰²æ¨¡å¼æ–‡å­—é¢œè‰² */
    @media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
      h1, h2, h3, h4, h5, h6 {
        color: #797979 !important;
      }
      
      label {
        color: #797979 !important;
      }
      
      .subtitle {
        color: var(--text-light) !important;
      }
      
      p, span, div {
        color: #797979 !important;
      }
    }
    
    .tabs {
      display: flex;
      background: var(--hover-color);
      border-radius: var(--radius-lg);
      padding: 0.25rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      overflow-x: auto;
      gap: 0.25rem;
    }
    
    .tab {
      flex: 1;
      min-width: fit-content;
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      position: relative;
    }
    
    .tab:hover {
      color: var(--text-primary);
      background: var(--background-color);
    }
    
    .tab.active {
      background: var(--primary-color);
      color: var(--text-light);
      box-shadow: var(--shadow-sm);
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(8px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    .alert {
      padding: 1rem 1.25rem;
      border-radius: var(--radius-md);
      margin-top: 1rem;
      border: 1px solid;
      font-size: 0.875rem;
    }
    
    .alert-error {
      background: #ffebee;
      border-color: #ffcdd2;
      color: #d32f2f;
    }
    
    .alert-success {
      background: #e8f5e9;
      border-color: #c8e6c9;
      color: #2e7d32;
    }
    
    .alert-warning {
      background: #fff8e1;
      border-color: #ffecb3;
      color: #f57c00;
    }
    
    .alert-info {
      background: #e3f2fd;
      border-color: #bbdefb;
      color: #1976d2;
    }
    
    /* Legacy support */
    .error {
      background: #ffebee;
      border: 1px solid #ffcdd2;
      color: #d32f2f;
      padding: 1rem 1.25rem;
      border-radius: var(--radius-md);
      margin-top: 1rem;
    }
    
    .success {
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
      padding: 1rem 1.25rem;
      border-radius: var(--radius-md);
      margin-top: 1rem;
    }
    .stat-card {
      background: white;
      border: 1px solid #f0f0f0;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    
    .stat-card:hover {
      border-color: #e0e0e0;
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .stat-card h4 {
      font-size: 0.875rem;
      font-weight: 500;
      color: #555555;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #222222;
      line-height: 1.2;
    }
    .chart-container {
      position: relative;
      height: 350px;
      margin: 25px 0;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .chart-container:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #e0e0e0;
      border-top: 2px solid var(--bg-accent2);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chart containers */
    .chart-container {
      background: white;
      border: 1px solid #f0f0f0;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin: 1rem 0;
      box-shadow: var(--shadow-sm);
    }
    
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .alert-overview {
      margin: 20px 0;
    }
    .alert-status-card {
      display: flex;
      align-items: center;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #6c757d;
    }
    .alert-status-card.info {
      border-left-color: #17a2b8;
      background: #e8f4f8;
    }
    .alert-status-card.warning {
      border-left-color: #ffc107;
      background: #fff8e1;
    }
    .alert-status-card.danger {
      border-left-color: #dc3545;
      background: #ffebee;
    }
    .alert-status-card.critical {
      border-left-color: #6f42c1;
      background: #f3e5f5;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    .status-icon {
      font-size: 48px;
      margin-right: 20px;
    }
    .status-text h4 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .status-text p {
      margin: 0;
      color: #333;
    }
    .alert-details {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .alert-item {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid #ddd;
    }
    .alert-item.warning {
      background: #fff8e1;
      border-left-color: #ffc107;
    }
    .alert-item.danger {
      background: #ffebee;
      border-left-color: #dc3545;
    }
    .alert-item.critical {
      background: #f3e5f5;
      border-left-color: #6f42c1;
    }
    .alert-icon {
      font-size: 24px;
      margin-right: 15px;
    }
    .alert-content {
      flex: 1;
    }
    .alert-content h5 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .alert-content p {
      margin: 0;
      color: #333;
      font-size: 14px;
    }
    .alert-value {
      font-weight: bold;
      color: #333;
      margin-left: 10px;
    }
    .alert-recommendations {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .recommendation-item {
      padding: 12px;
      margin: 8px 0;
      background: #e8f5e9;
      border-left: 3px solid var(--bg-accent1);
      border-radius: 4px;
    }
    .threshold-info {
      margin-top: 15px;
    }
    .threshold-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .threshold-card h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
    }
    .threshold-card p {
      margin: 5px 0;
      font-size: 13px;
      color: #333;
    }
  </style>
  
  <!-- ç®€åŒ–çš„æ–‡å­—é¢œè‰²ä¿®å¤ -->
  <style>
    /* ç¡®ä¿æ–‡å­—é¢œè‰²ç»Ÿä¸€ */
    h1, h2, h3, h4, h5, h6 {
      color: var(--text-primary) !important;
    }
    
    label {
      color: var(--text-primary) !important;
    }
    
    .subtitle {
      color: var(--text-light) !important;
    }
    
    /* æ›´æ–°æ‰€æœ‰å†…å®¹æ–‡å­—é¢œè‰² */
    p, span, div, small {
      color: var(--text-primary);
    }
    
    /* å›¾è¡¨å’Œå¡ç‰‡èƒŒæ™¯æ›´æ–° */
    .chart-container,
    .stat-card,
    .advice-item,
    .result-box {
      background: var(--background-color) !important;
      border: 1px solid var(--border-color) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒ¾ CropPilot</h1>
      <p class="subtitle">æ™ºèƒ½å†œä¸šå†³ç­–æ”¯æŒç³»ç»Ÿ</p>
      
      <div class="user-selector">
        <div class="form-group">
          <label>é€‰æ‹©ç”¨æˆ·</label>
          <select id="userSelect">
            <option value="">å…¨éƒ¨ç”¨æˆ·</option>
          </select>
          <small>é€‰æ‹©ç”¨æˆ·åå°†åªæ˜¾ç¤ºå…¶åœ°å—</small>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('advice')">ğŸŒ¾ å†œäº‹å»ºè®®</button>
        <button class="tab" onclick="switchTab('smart')">ğŸ¤– æ™ºèƒ½å’¨è¯¢</button>
        <button class="tab" onclick="switchTab('sensor')">ğŸ“Š ä¼ æ„Ÿå™¨æ•°æ®</button>
        <button class="tab" onclick="switchTab('charts')">ğŸ“ˆ æ•°æ®å¯è§†åŒ–</button>
        <button class="tab" onclick="switchTab('alerts')">ğŸš¨ å¼‚å¸¸é¢„è­¦</button>
        <button class="tab" onclick="switchTab('history')">ğŸ“œ å†å²è®°å½•</button>
      </div>

    <!-- å†œäº‹å»ºè®®æ ‡ç­¾é¡µ -->
    <div id="advice-tab" class="tab-content active">
      <div class="section">
        <div class="section-header">
          <h2>ğŸŒ± è·å–å†œäº‹å»ºè®®</h2>
        </div>
        <div class="section-content">
          <div class="form-group">
            <label>åœ°å—</label>
            <select id="fieldSelect">
              <option value="">è¯·é€‰æ‹©åœ°å—</option>
            </select>
            <small>é€‰æ‹©åœ°å—åè‡ªåŠ¨å¸¦å‡ºä½œç‰©ç±»å‹</small>
          </div>
          
          <div class="form-group">
            <label>ä½œç‰©ç±»å‹</label>
            <select id="cropSelect">
              <option value="æ°´ç¨»">æ°´ç¨»</option>
              <option value="ç‰ç±³">ç‰ç±³</option>
            </select>
            
            <label>ç”Ÿé•¿é˜¶æ®µ</label>
            <select id="stageSelect">
              <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
              <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
              <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
              <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
            </select>
            
            <button onclick="getAdvice()" class="btn btn-primary">è·å–å»ºè®®</button>
          </div>
          
          <div id="adviceResult" class="result-box">
            <p>å†œäº‹å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ™ºèƒ½å’¨è¯¢æ ‡ç­¾é¡µ -->
    <div id="smart-tab" class="tab-content">
      <div class="section">
        <div class="section-header">
          <h2>ğŸ¤– æ™ºèƒ½å†œä¸šå’¨è¯¢</h2>
          <p style="margin-top: 0.5rem;">åŸºäºå†œä¸šçŸ¥è¯†åº“çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢</p>
        </div>
        <div class="section-content">
          <div class="form-group">
            <label>é€‰æ‹©åœ°å—</label>
            <select id="smartFieldSelect">
              <option value="">è¯·é€‰æ‹©åœ°å—ï¼ˆå¯é€‰ï¼‰</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>å’¨è¯¢é—®é¢˜</label>
            <textarea id="smartQuestion" rows="3" 
                      placeholder="ä¾‹å¦‚ï¼šæ°´ç¨»å¶å­å‘é»„æ€ä¹ˆåŠï¼Ÿç‰ç±³æ‹”èŠ‚æœŸå¦‚ä½•æ–½è‚¥ï¼Ÿé«˜æ¸©å¤©æ°”æ³¨æ„ä»€ä¹ˆï¼Ÿ"></textarea>
          </div>
          
          <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
            <button onclick="getSmartAdvice()" class="btn btn-primary">ğŸ” æ™ºèƒ½å’¨è¯¢</button>
            <button onclick="clearSmartQuery()" class="btn btn-secondary">æ¸…ç©º</button>
          </div>
          
          <div id="smartResult" class="result-box" style="margin-top: 1.5rem;">
            <p>æ™ºèƒ½å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
          </div>
          
          <div style="margin-top: 1.5rem; padding: 1rem; background: var(--hover-color); border-radius: var(--radius-md);">
            <h4 style="margin-bottom: 0.75rem;">ğŸ’¬ å¸¸è§é—®é¢˜ç¤ºä¾‹</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem;">
              <button onclick="setSmartQuestion('å¶å­å‘é»„æ€ä¹ˆåŠ')" class="btn btn-secondary" style="font-size: 0.75rem;">å¶å­å‘é»„æ€ä¹ˆåŠ</button>
              <button onclick="setSmartQuestion('å¦‚ä½•é˜²æ²»ç—…è™«å®³')" class="btn btn-secondary" style="font-size: 0.75rem;">å¦‚ä½•é˜²æ²»ç—…è™«å®³</button>
              <button onclick="setSmartQuestion('é«˜æ¸©å¹²æ—±åº”å¯¹æªæ–½')" class="btn btn-secondary" style="font-size: 0.75rem;">é«˜æ¸©å¹²æ—±åº”å¯¹</button>
              <button onclick="setSmartQuestion('åœŸå£¤pHå€¼è°ƒèŠ‚')" class="btn btn-secondary" style="font-size: 0.75rem;">åœŸå£¤pHè°ƒèŠ‚</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¼ æ„Ÿå™¨æ•°æ®æ ‡ç­¾é¡µ -->
    <div id="sensor-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“Š å½•å…¥ä¼ æ„Ÿå™¨æ•°æ®</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="sensorFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="sensorCropSelect">
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="sensorStageSelect">
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
        </div>

        <div class="section" style="margin-top: 10px;">
          <h3>ğŸ–¼ ä¸Šä¼ ä½œç‰©å›¾ç‰‡</h3>
          <p style="margin-bottom:10px;">å…ˆé€‰æ‹©ä¸Šæ–¹åœ°å—ï¼Œå†ä¸Šä¼ å›¾ç‰‡ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°ç³»ç»Ÿå¹¶è®°å½•è·¯å¾„ä¸æ—¶é—´ï¼‰ã€‚</p>
          <div class="form-group">
            <label>æ‹æ‘„æ—¶é—´ï¼š</label>
            <input type="datetime-local" id="capturedAt">
          </div>
          <div class="form-group">
            <label>ä½œç‰©å›¾ç‰‡ï¼š</label>
            <input type="file" id="cropImageFile" accept="image/*" style="flex:1;">
            <button onclick="uploadCropImage()" style="margin-left:10px;">ä¸Šä¼ ä½œç‰©å›¾ç‰‡</button>
          </div>
          <div id="uploadResult"></div>
        </div>
        
        <div class="sensor-grid">
          <div class="sensor-input">
            <label>ğŸŒ¡ï¸ æ¸©åº¦:</label>
            <input type="number" id="temperature" step="0.1" placeholder="ä¾‹å¦‚: 25.5">
            <div class="unit">å•ä½: Â°C | æ­£å¸¸èŒƒå›´: 15-35Â°C</div>
          </div>
          <div class="sensor-input">
            <label>ğŸ’§ æ¹¿åº¦:</label>
            <input type="number" id="humidity" step="0.1" placeholder="ä¾‹å¦‚: 65.0">
            <div class="unit">å•ä½: % | æ­£å¸¸èŒƒå›´: 40-95%</div>
          </div>
          <div class="sensor-input">
            <label>ğŸŒ± åœŸå£¤æ¹¿åº¦:</label>
            <input type="number" id="soilMoisture" step="0.1" placeholder="ä¾‹å¦‚: 70.0">
            <div class="unit">å•ä½: % | æ­£å¸¸èŒƒå›´: 50-95%</div>
          </div>
          <div class="sensor-input">
            <label>â˜€ï¸ å…‰ç…§å¼ºåº¦:</label>
            <input type="number" id="lightIntensity" step="0.1" placeholder="ä¾‹å¦‚: 50000">
            <div class="unit">å•ä½: lux | æ­£å¸¸èŒƒå›´: 10000-120000</div>
          </div>
          <div class="sensor-input">
            <label>âš—ï¸ pHå€¼:</label>
            <input type="number" id="phValue" step="0.1" placeholder="ä¾‹å¦‚: 6.5">
            <div class="unit">èŒƒå›´: 5.5-8.0 | æœ€é€‚: 6.0-7.5</div>
          </div>
          <div class="sensor-input">
            <label>ğŸŸ¦ æ°®å«é‡:</label>
            <input type="number" id="nitrogen" step="0.1" placeholder="ä¾‹å¦‚: 150.0">
            <div class="unit">å•ä½: mg/kg | æ­£å¸¸èŒƒå›´: 80-300</div>
          </div>
          <div class="sensor-input">
            <label>ğŸŸ¨ ç£·å«é‡:</label>
            <input type="number" id="phosphorus" step="0.1" placeholder="ä¾‹å¦‚: 80.0">
            <div class="unit">å•ä½: mg/kg | æ­£å¸¸èŒƒå›´: 30-180</div>
          </div>
          <div class="sensor-input">
            <label>ğŸŸ¥ é’¾å«é‡:</label>
            <input type="number" id="potassium" step="0.1" placeholder="ä¾‹å¦‚: 120.0">
            <div class="unit">å•ä½: mg/kg | æ­£å¸¸èŒƒå›´: 60-250</div>
          </div>
          <div class="sensor-input">
            <label>ğŸ“ ä½ç½®/åœ°å—:</label>
            <input type="text" id="location" placeholder="ä¾‹å¦‚: AåŒº-1å·ç”°">
            <div class="unit">æè¿°ä¼ æ„Ÿå™¨å®‰è£…ä½ç½®</div>
          </div>
        </div>
        
        <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
          <button onclick="saveSensorData()" style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent1));">
            ğŸ’¾ ä¿å­˜ä¼ æ„Ÿå™¨æ•°æ®
          </button>
          <button onclick="getAdviceWithSensor()" style="background: linear-gradient(135deg, var(--bg-accent2), var(--bg-accent1));">
            ğŸ¤– åŸºäºæ•°æ®è·å–å»ºè®®
          </button>
          <button onclick="clearSensorData()" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));">
            ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
          </button>
        </div>
        
        <div id="sensorResult"></div>
      </div>
    </div>

    <!-- æ•°æ®å¯è§†åŒ–æ ‡ç­¾é¡µ -->
    <div id="charts-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“Š æ•°æ®å¯è§†åŒ–åˆ†æ</h2>
        <p style="margin-bottom:15px;">ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿å›¾è¡¨å’Œç»Ÿè®¡åˆ†æ</p>
        
        <div class="form-group">
          <label>é€‰æ‹©åœ°å—ï¼š</label>
          <select id="chartFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
          <label>æ—¶é—´èŒƒå›´ï¼š</label>
          <select id="chartTimeRange">
            <option value="7">æœ€è¿‘7å¤©</option>
            <option value="30">æœ€è¿‘30å¤©</option>
            <option value="90">æœ€è¿‘90å¤©</option>
          </select>
          <button onclick="loadChartData()" style="background: var(--bg-accent2);">ğŸ“ˆ åŠ è½½å›¾è¡¨</button>
          <button onclick="refreshCharts()" style="background: var(--bg-accent1); margin-left: 10px;">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div class="form-group" style="margin-top: 15px; padding: 10px; background: var(--accent-color); border-radius: 4px; opacity: 0.8;">
          <label style="color: white;">æ¼”ç¤ºåŠŸèƒ½ï¼š</label>
          <button onclick="generateDemoData()" style="background: var(--primary-color); color: white;">ğŸ² ç”Ÿæˆæ¼”ç¤ºæ•°æ®</button>
          <small style="color: white; margin-left: 10px;">ä¸ºé€‰ä¸­çš„åœ°å—ç”Ÿæˆ7å¤©çš„æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®ç”¨äºå›¾è¡¨æ¼”ç¤º</small>
        </div>
      </div>

      <!-- å›¾è¡¨å®¹å™¨ -->
      <div class="section">
        <h3>ğŸŒ¡ï¸ ç¯å¢ƒå‚æ•°è¶‹åŠ¿å›¾</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">æ¸©åº¦ & æ¹¿åº¦è¶‹åŠ¿</h4>
            <canvas id="tempHumidityChart" width="400" height="200"></canvas>
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">åœŸå£¤æ¹¿åº¦ & pHå€¼</h4>
            <canvas id="soilChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ğŸŒ± è¥å…»å…ƒç´ åˆ†æ</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">NPKè¥å…»å…ƒç´ è¶‹åŠ¿</h4>
            <canvas id="nutrientChart" width="400" height="200"></canvas>
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">å…‰ç…§å¼ºåº¦å˜åŒ–</h4>
            <canvas id="lightChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ğŸ“ˆ æ•°æ®ç»Ÿè®¡æ‘˜è¦</h3>
        <div id="chartSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="stat-card">
            <h4>æ¸©åº¦</h4>
            <div class="stat-value" id="tempStats">--</div>
          </div>
          <div class="stat-card">
            <h4>æ¹¿åº¦</h4>
            <div class="stat-value" id="humidityStats">--</div>
          </div>
          <div class="stat-card">
            <h4>åœŸå£¤æ¹¿åº¦</h4>
            <div class="stat-value" id="soilMoistureStats">--</div>
          </div>
          <div class="stat-card">
            <h4>pHå€¼</h4>
            <div class="stat-value" id="phStats">--</div>
          </div>
        </div>
      </div>

      <div id="chartLoadingMessage" style="text-align: center; padding: 40px; color: #333;">
        <p>ğŸ“Š é€‰æ‹©åœ°å—å¹¶ç‚¹å‡»"åŠ è½½å›¾è¡¨"æŸ¥çœ‹æ•°æ®å¯è§†åŒ–</p>
      </div>
    </div>

    <!-- å¼‚å¸¸é¢„è­¦æ ‡ç­¾é¡µ -->
    <div id="alerts-tab" class="tab-content">
      <div class="section">
        <h2>ğŸš¨ å¼‚å¸¸æ£€æµ‹ä¸é¢„è­¦</h2>
        <p style="margin-bottom:15px;">å®æ—¶ç›‘æµ‹ä¼ æ„Ÿå™¨æ•°æ®å¼‚å¸¸ï¼Œæä¾›æ™ºèƒ½é¢„è­¦å’Œå¤„ç†å»ºè®®</p>
        
        <div class="form-group">
          <label>é€‰æ‹©åœ°å—ï¼š</label>
          <select id="alertFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
          <button onclick="checkFieldAlerts()" style="background: var(--bg-secondary);">ğŸ” æ£€æŸ¥é¢„è­¦</button>
          <button onclick="refreshAlerts()" style="background: var(--bg-accent1); margin-left: 10px;">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div class="form-group" style="margin-top: 15px; padding: 10px; background: var(--hover-color); border-radius: 4px; border-left: 4px solid var(--primary-color);">
          <label>å®æ—¶æ£€æµ‹ï¼š</label>
          <button onclick="enableAutoCheck()" id="autoCheckBtn" style="background: var(--primary-color); color: white;">ğŸ”„ å¯ç”¨è‡ªåŠ¨æ£€æµ‹</button>
          <small style="margin-left: 10px;">æ¯30ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡é¢„è­¦çŠ¶æ€</small>
        </div>
      </div>

      <!-- é¢„è­¦çŠ¶æ€æ¦‚è§ˆ -->
      <div class="section">
        <h3>ğŸ“Š é¢„è­¦çŠ¶æ€æ¦‚è§ˆ</h3>
        <div id="alertOverview" class="alert-overview">
          <div class="alert-status-card" id="alertStatusCard">
            <div class="status-icon">ğŸ”</div>
            <div class="status-text">
              <h4>ç­‰å¾…æ£€æµ‹</h4>
              <p>è¯·é€‰æ‹©åœ°å—å¹¶ç‚¹å‡»"æ£€æŸ¥é¢„è­¦"</p>
            </div>
          </div>
        </div>
      </div>

      <!-- è¯¦ç»†é¢„è­¦ä¿¡æ¯ -->
      <div class="section">
        <h3>âš ï¸ è¯¦ç»†é¢„è­¦ä¿¡æ¯</h3>
        <div id="alertDetails" class="alert-details">
          <p style="color: #333; text-align: center; padding: 20px;">é¢„è­¦è¯¦æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>

      <!-- å¤„ç†å»ºè®® -->
      <div class="section">
        <h3>ğŸ’¡ å¤„ç†å»ºè®®</h3>
        <div id="alertRecommendations" class="alert-recommendations">
          <p style="color: #333; text-align: center; padding: 20px;">å¤„ç†å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>

      <!-- å‚æ•°é˜ˆå€¼è®¾ç½® -->
      <div class="section" style="background: #f8f9fa; border-left-color: #6c757d;">
        <h3>âš™ï¸ é¢„è­¦é˜ˆå€¼å‚è€ƒ</h3>
        <div class="threshold-info">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="threshold-card">
              <h4>ğŸŒ¡ï¸ æ¸©åº¦èŒƒå›´</h4>
              <p><strong>æ°´ç¨»:</strong> 15-35Â°C (æœ€é€‚: 20-30Â°C)</p>
              <p><strong>ç‰ç±³:</strong> 10-40Â°C (æœ€é€‚: 18-32Â°C)</p>
            </div>
            <div class="threshold-card">
              <h4>ğŸ’§ æ¹¿åº¦èŒƒå›´</h4>
              <p><strong>æ°´ç¨»:</strong> 50-95% (æœ€é€‚: 60-85%)</p>
              <p><strong>ç‰ç±³:</strong> 40-85% (æœ€é€‚: 50-75%)</p>
            </div>
            <div class="threshold-card">
              <h4>ğŸŒ± åœŸå£¤æ¹¿åº¦</h4>
              <p><strong>æ°´ç¨»:</strong> 60-95% (æœ€é€‚: 70-90%)</p>
              <p><strong>ç‰ç±³:</strong> 50-85% (æœ€é€‚: 60-80%)</p>
            </div>
            <div class="threshold-card">
              <h4>âš—ï¸ pHå€¼èŒƒå›´</h4>
              <p><strong>æ°´ç¨»:</strong> 5.5-7.5 (æœ€é€‚: 6.0-7.0)</p>
              <p><strong>ç‰ç±³:</strong> 6.0-8.0 (æœ€é€‚: 6.5-7.5)</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å†å²è®°å½•æ ‡ç­¾é¡µ -->
    <div id="history-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“œ æŸ¥è¯¢å†å²è®°å½•</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="historyFieldSelect">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="historyCropSelect">
            <option value="">å…¨éƒ¨</option>
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="historyStageSelect">
            <option value="">å…¨éƒ¨</option>
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
          
          <button onclick="loadHistory()">æŸ¥è¯¢å†å²</button>
        </div>
        
        <div id="historyResult" class="result-box">
          <p style="color: #333;">å†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç®€å•çš„ç¼“å­˜
    let usersCache = [];
    let fieldsCache = [];
    let chartInstances = {}; // å­˜å‚¨å›¾è¡¨å®ä¾‹

    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(data => {
          if (data.status !== 'success') return;
          usersCache = data.users || [];
          const sel = document.getElementById('userSelect');
          if (sel) {
            const firstOption = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(firstOption);
            usersCache.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.id;
              opt.textContent = `${u.username} (${u.role})`;
              sel.appendChild(opt);
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·å¹¶åŠ è½½å…¶åœ°å—
            if (usersCache.length > 0) {
              sel.value = usersCache[0].id;
              loadFields(usersCache[0].id);
            } else {
              loadFields();
            }
          }
        })
        .catch(err => console.error('åŠ è½½ç”¨æˆ·å¤±è´¥', err));
    }

    function loadFields(userId) {
      let url = '/api/fields';
      if (userId) {
        const params = new URLSearchParams();
        params.append('user_id', userId);
        url += `?${params.toString()}`;
      }
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.status !== 'success') return;
          fieldsCache = data.fields || [];
          const fieldSelectIds = ['fieldSelect', 'sensorFieldSelect', 'historyFieldSelect', 'smartFieldSelect'];
          fieldSelectIds.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            // å…ˆä¿ç•™ç¬¬ä¸€ä¸ªå ä½é¡¹
            const firstOption = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(firstOption);
            // å¦‚æœåˆ‡æ¢ç”¨æˆ·ï¼Œåˆ™é‡ç½®é€‰ä¸­é¡¹ä¸ºç©º
            sel.value = '';
            fieldsCache.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f.id;
              opt.textContent = `${f.name} (${f.crop_type})`;
              sel.appendChild(opt);
            });
          });
        })
        .catch(err => console.error('åŠ è½½åœ°å—å¤±è´¥', err));
    }

    function getFieldById(fieldId) {
      return fieldsCache.find(f => String(f.id) === String(fieldId));
    }

    function switchTab(tabName) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„activeç±»
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
      });
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      document.getElementById(tabName + '-tab').classList.add('active');
      // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
      event.target.classList.add('active');
    }

    function getAdvice() {
      const fieldId = document.getElementById('fieldSelect').value;
      const crop = document.getElementById('cropSelect').value;
      const stage = document.getElementById('stageSelect').value;
      
      const resultDiv = document.getElementById('adviceResult');
      resultDiv.innerHTML = `
        <div style="text-align: center; padding: 25px;">
          <span class="loading-spinner"></span>
          <p style="margin-top: 15px; color: var(--text-primary); font-weight: 500;">ğŸ“‹ æ­£åœ¨ç”Ÿæˆå†œäº‹å»ºè®®...</p>
        </div>
      `;

      const params = new URLSearchParams();
      if (fieldId) params.append('field_id', fieldId);
      params.append('crop', crop);
      params.append('stage', stage);
      
      fetch(`/api/get_advice?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            let html = `
              <div style="background: linear-gradient(135deg, var(--bg-light), var(--bg-primary)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--bg-accent1);">
                <h4 style="color: var(--text-primary); margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
                  ğŸŒ¾ ${data.crop} - ${data.stage}
                  <span style="background: var(--bg-accent1); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: normal;">ä¸“ä¸šå»ºè®®</span>
                </h4>
              </div>
            `;
            
            if (data.advice && data.advice.length > 0) {
              data.advice.forEach((item, index) => {
                html += `
                  <div class="advice-item" style="animation: slideIn 0.3s ease-out ${index * 0.1}s both;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                      <span style="background: var(--bg-accent2); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">${index + 1}</span>
                      <div style="flex: 1;">${item}</div>
                    </div>
                  </div>
                `;
              });
            } else {
              html += '<div class="advice-item">æš‚æ— å…·ä½“å»ºè®®ï¼Œè¯·è”ç³»å†œæŠ€ä¸“å®¶è·å–æ›´å¤šæŒ‡å¯¼ã€‚</div>';
            }
            
            resultDiv.innerHTML = html;
            showNotification('å†œäº‹å»ºè®®è·å–æˆåŠŸ', 'success');
          } else {
            resultDiv.innerHTML = '<div class="error">âŒ è·å–å»ºè®®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            showNotification('è·å–å»ºè®®å¤±è´¥', 'error');
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          resultDiv.innerHTML = '<div class="error">âŒ è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨</div>';
          showNotification('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        });
    }

    function uploadCropImage() {
      const fieldId = document.getElementById('sensorFieldSelect').value;
      const uploadResult = document.getElementById('uploadResult');
      const fileInput = document.getElementById('cropImageFile');
      const capturedAt = document.getElementById('capturedAt').value;

      if (!fieldId) {
        uploadResult.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©åœ°å—</div>';
        return;
      }

      if (!fileInput || fileInput.files.length === 0) {
        uploadResult.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡</div>';
        return;
      }

      const formData = new FormData();
      formData.append('field_id', fieldId);
      formData.append('image', fileInput.files[0]);
      if (capturedAt) {
        formData.append('captured_at', capturedAt);
      }

      uploadResult.innerHTML = '<p>æ­£åœ¨ä¸Šä¼ ...</p>';

      fetch('/api/upload_crop_image', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const link = data.image_path ? `<a href="${data.image_path}" target="_blank">æŸ¥çœ‹å›¾ç‰‡</a>` : '';
            uploadResult.innerHTML = `<div class="success">ä¸Šä¼ æˆåŠŸï¼${link}</div>`;
            fileInput.value = '';
          } else {
            uploadResult.innerHTML = `<div class="error">ä¸Šä¼ å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          uploadResult.innerHTML = '<div class="error">ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•ã€‚</div>';
        });
    }

    function saveSensorData() {
      saveSensorDataWithAlert();
    }

    function getAdviceWithSensor() {
      // å…ˆä¿å­˜æ•°æ®ï¼Œç„¶åç›´æ¥è·å–å½“å‰ä½œç‰©+é˜¶æ®µçš„å»ºè®®
      saveSensorData();
      getAdvice();
    }

    function loadHistory() {
      const fieldId = document.getElementById('historyFieldSelect').value;
      const crop = document.getElementById('historyCropSelect').value;
      const stage = document.getElementById('historyStageSelect').value;
      
      let url = '/api/get_history';
      const params = new URLSearchParams();
      if (fieldId) params.append('field_id', fieldId);
      if (crop) params.append('crop', crop);
      if (stage) params.append('stage', stage);
      if (params.toString()) url += '?' + params.toString();
      
      document.getElementById('historyResult').innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            let html = '<h3>å†³ç­–è®°å½• (' + data.count + ' æ¡)</h3>';
            if (data.records && data.records.length > 0) {
              data.records.forEach(record => {
                html += `<div class="advice-item" style="margin-bottom: 15px;">`;
                html += `<p><strong>${record.crop_type} - ${record.growth_stage}</strong></p>`;
                html += `<p>${record.advice}</p>`;
                html += `<p style="color: #333; font-size: 12px;">${record.created_at}</p>`;
                html += `</div>`;
              });
            } else {
              html += '<p>æš‚æ— å†å²è®°å½•</p>';
            }
            document.getElementById('historyResult').innerHTML = html;
          } else {
            document.getElementById('historyResult').innerHTML = 
              '<div class="error">æŸ¥è¯¢å¤±è´¥</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('historyResult').innerHTML = 
            '<div class="error">è¯·æ±‚å¤±è´¥</div>';
        });
    }

    // é€‰åœ°å—æ—¶è‡ªåŠ¨å¸¦å‡ºä½œç‰©ç±»å‹
    document.addEventListener('change', (e) => {
      if (e.target.id === 'userSelect') {
        const userId = e.target.value;
        loadFields(userId);
        return;
      }
      if (e.target.id === 'fieldSelect' || e.target.id === 'sensorFieldSelect') {
        const fieldId = e.target.value;
        const field = getFieldById(fieldId);
        if (field) {
          if (e.target.id === 'fieldSelect') {
            document.getElementById('cropSelect').value = field.crop_type;
          }
          if (e.target.id === 'sensorFieldSelect') {
            document.getElementById('sensorCropSelect').value = field.crop_type;
          }
        }
      }
    });

    function getSmartAdvice() {
      const fieldId = document.getElementById('smartFieldSelect').value;
      const question = document.getElementById('smartQuestion').value.trim();
      
      if (!question) {
        showNotification('è¯·è¾“å…¥å’¨è¯¢é—®é¢˜', 'warning');
        document.getElementById('smartResult').innerHTML = '<div class="error">âŒ è¯·è¾“å…¥å’¨è¯¢é—®é¢˜</div>';
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const resultDiv = document.getElementById('smartResult');
      resultDiv.innerHTML = `
        <div style="text-align: center; padding: 30px;">
          <span class="loading-spinner"></span>
          <p style="margin-top: 15px; color: var(--text-primary); font-weight: 500;">ğŸ¤– AIæ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...</p>
          <p style="margin-top: 5px; color: #888; font-size: 14px;">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´</p>
        </div>
      `;
      
      // è·å–åœ°å—ä¿¡æ¯ä»¥ç¡®å®šä½œç‰©ç±»å‹
      let cropType = '';
      let growthStage = '';
      if (fieldId) {
        const field = getFieldById(fieldId);
        if (field) {
          cropType = field.crop_type;
        }
      }
      
      const requestData = {
        question: question,
        crop_type: cropType,
        growth_stage: growthStage
      };
      
      fetch('/api/smart_advice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // æ ¼å¼åŒ–æ™ºèƒ½å»ºè®®æ˜¾ç¤º
            let html = `
              <div style="background: linear-gradient(135deg, var(--bg-light), var(--bg-primary)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--bg-accent1);">
                <h4 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                  ğŸ¤– AIæ™ºèƒ½åˆ†æç»“æœ
                  <span style="background: var(--bg-accent1); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: normal;">æ™ºèƒ½å›ç­”</span>
                </h4>
                <div style="background: var(--bg-light); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid var(--bg-accent2);">
                  <p style="margin: 0; color: var(--text-primary);"><strong>ğŸ’¬ é—®é¢˜ï¼š</strong>${data.question}</p>
                  ${data.crop_type ? `<p style="margin: 8px 0 0 0; color: var(--text-primary);"><strong>ğŸŒ± ä½œç‰©ï¼š</strong>${data.crop_type}</p>` : ''}
                </div>
              </div>
            `;
            
            // æ˜¾ç¤ºå»ºè®®å†…å®¹
            html += `
              <div style="background: var(--bg-light); padding: 25px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); border: 2px solid var(--bg-accent2);">
                <h4 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                  ğŸ’¡ ä¸“ä¸šå»ºè®®
                </h4>
                <div style="white-space: pre-line; line-height: 1.8; color: #444; font-size: 15px;">${data.advice}</div>
              </div>
            `;
            
            resultDiv.innerHTML = html;
            showNotification('æ™ºèƒ½å’¨è¯¢å®Œæˆ', 'success');
          } else {
            resultDiv.innerHTML = 
              `<div class="error">âŒ æ™ºèƒ½å’¨è¯¢å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
            showNotification('æ™ºèƒ½å’¨è¯¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(error => {
          console.error('æ™ºèƒ½å’¨è¯¢é”™è¯¯:', error);
          resultDiv.innerHTML = 
            '<div class="error">âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥æˆ–ç¨åé‡è¯•</div>';
          showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
        });
    }
    
    function setSmartQuestion(question) {
      document.getElementById('smartQuestion').value = question;
    }
    
    function clearSmartQuery() {
      document.getElementById('smartQuestion').value = '';
      document.getElementById('smartResult').innerHTML = '<p style="color: #333;">æ™ºèƒ½å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>';
    }

    // æ•°æ®å¯è§†åŒ–ç›¸å…³å‡½æ•°
    function loadChartData() {
      const fieldId = document.getElementById('chartFieldSelect').value;
      const timeRange = document.getElementById('chartTimeRange').value;
      
      if (!fieldId) {
        document.getElementById('chartLoadingMessage').innerHTML = 
          '<p>è¯·å…ˆé€‰æ‹©åœ°å—</p>';
        return;
      }
      
      document.getElementById('chartLoadingMessage').innerHTML = 
        '<p><span class="loading-spinner"></span> æ­£åœ¨åŠ è½½æ•°æ®...</p>';
      
      // è·å–ä¼ æ„Ÿå™¨æ•°æ®
      const params = new URLSearchParams();
      params.append('field_id', fieldId);
      params.append('limit', timeRange * 10); // å‡è®¾æ¯å¤©æœ‰å¤šæ¡æ•°æ®
      
      fetch(`/api/get_sensor_data?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.data && data.data.length > 0) {
            renderCharts(data.data);
            calculateStatistics(data.data);
            document.getElementById('chartLoadingMessage').style.display = 'none';
          } else {
            document.getElementById('chartLoadingMessage').innerHTML = 
              '<p style="color: #333;">ğŸ“Š è¯¥åœ°å—æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®</p>';
          }
        })
        .catch(error => {
          console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
          document.getElementById('chartLoadingMessage').innerHTML = 
            '<p>âŒ æ•°æ®åŠ è½½å¤±è´¥</p>';
        });
    }
    
    function renderCharts(sensorData) {
      // å‡†å¤‡æ•°æ®
      const labels = sensorData.map(item => {
        const date = new Date(item.recorded_at);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
      }).reverse();
      
      const temperatures = sensorData.map(item => item.temperature).reverse();
      const humidities = sensorData.map(item => item.humidity).reverse();
      const soilMoistures = sensorData.map(item => item.soil_moisture).reverse();
      const phValues = sensorData.map(item => item.ph_value).reverse();
      const nitrogens = sensorData.map(item => item.nitrogen).reverse();
      const phosphorus = sensorData.map(item => item.phosphorus).reverse();
      const potassiums = sensorData.map(item => item.potassium).reverse();
      const lightIntensities = sensorData.map(item => item.light_intensity).reverse();
      
      // æ¸©åº¦æ¹¿åº¦å›¾è¡¨
      renderTempHumidityChart(labels, temperatures, humidities);
      
      // åœŸå£¤å›¾è¡¨
      renderSoilChart(labels, soilMoistures, phValues);
      
      // è¥å…»å…ƒç´ å›¾è¡¨
      renderNutrientChart(labels, nitrogens, phosphorus, potassiums);
      
      // å…‰ç…§å›¾è¡¨
      renderLightChart(labels, lightIntensities);
    }
    
    function renderTempHumidityChart(labels, temperatures, humidities) {
      const ctx = document.getElementById('tempHumidityChart').getContext('2d');
      
      // é”€æ¯ç°æœ‰å›¾è¡¨
      if (chartInstances.tempHumidity) {
        chartInstances.tempHumidity.destroy();
      }
      
      chartInstances.tempHumidity = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ¸©åº¦ (Â°C)',
            data: temperatures,
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'æ¹¿åº¦ (%)',
            data: humidities,
            borderColor: '#4ecdc4',
            backgroundColor: 'rgba(78, 205, 196, 0.1)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'æ¸©åº¦ (Â°C)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'æ¹¿åº¦ (%)'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    }
    
    function renderSoilChart(labels, soilMoistures, phValues) {
      const ctx = document.getElementById('soilChart').getContext('2d');
      
      if (chartInstances.soil) {
        chartInstances.soil.destroy();
      }
      
      chartInstances.soil = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'åœŸå£¤æ¹¿åº¦ (%)',
            data: soilMoistures,
            borderColor: '#45b7d1',
            backgroundColor: 'rgba(69, 183, 209, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'pHå€¼',
            data: phValues,
            borderColor: '#f9ca24',
            backgroundColor: 'rgba(249, 202, 36, 0.1)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'åœŸå£¤æ¹¿åº¦ (%)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'pHå€¼'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    }
    
    function renderNutrientChart(labels, nitrogens, phosphorus, potassiums) {
      const ctx = document.getElementById('nutrientChart').getContext('2d');
      
      if (chartInstances.nutrient) {
        chartInstances.nutrient.destroy();
      }
      
      chartInstances.nutrient = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ°® (mg/kg)',
            data: nitrogens,
            borderColor: '#6c5ce7',
            backgroundColor: 'rgba(108, 92, 231, 0.1)'
          }, {
            label: 'ç£· (mg/kg)',
            data: phosphorus,
            borderColor: '#a29bfe',
            backgroundColor: 'rgba(162, 155, 254, 0.1)'
          }, {
            label: 'é’¾ (mg/kg)',
            data: potassiums,
            borderColor: '#fd79a8',
            backgroundColor: 'rgba(253, 121, 168, 0.1)'
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'å«é‡ (mg/kg)'
              }
            }
          }
        }
      });
    }
    
    function renderLightChart(labels, lightIntensities) {
      const ctx = document.getElementById('lightChart').getContext('2d');
      
      if (chartInstances.light) {
        chartInstances.light.destroy();
      }
      
      chartInstances.light = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å…‰ç…§å¼ºåº¦ (lux)',
            data: lightIntensities,
            borderColor: '#fdcb6e',
            backgroundColor: 'rgba(253, 203, 110, 0.1)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'å…‰ç…§å¼ºåº¦ (lux)'
              }
            }
          }
        }
      });
    }
    
    function calculateStatistics(sensorData) {
      const stats = {
        temperature: calculateStat(sensorData, 'temperature'),
        humidity: calculateStat(sensorData, 'humidity'),
        soilMoisture: calculateStat(sensorData, 'soil_moisture'),
        ph: calculateStat(sensorData, 'ph_value')
      };
      
      document.getElementById('tempStats').innerHTML = 
        `å¹³å‡: ${stats.temperature.avg}Â°C<br>èŒƒå›´: ${stats.temperature.min}Â°C - ${stats.temperature.max}Â°C`;
      document.getElementById('humidityStats').innerHTML = 
        `å¹³å‡: ${stats.humidity.avg}%<br>èŒƒå›´: ${stats.humidity.min}% - ${stats.humidity.max}%`;
      document.getElementById('soilMoistureStats').innerHTML = 
        `å¹³å‡: ${stats.soilMoisture.avg}%<br>èŒƒå›´: ${stats.soilMoisture.min}% - ${stats.soilMoisture.max}%`;
      document.getElementById('phStats').innerHTML = 
        `å¹³å‡: ${stats.ph.avg}<br>èŒƒå›´: ${stats.ph.min} - ${stats.ph.max}`;
    }
    
    function calculateStat(data, field) {
      const values = data.map(item => parseFloat(item[field])).filter(v => !isNaN(v));
      if (values.length === 0) {
        return { avg: '--', min: '--', max: '--' };
      }
      
      const sum = values.reduce((a, b) => a + b, 0);
      const avg = (sum / values.length).toFixed(1);
      const min = Math.min(...values).toFixed(1);
      const max = Math.max(...values).toFixed(1);
      
      return { avg, min, max };
    }
    
    function refreshCharts() {
      loadChartData();
    }
    
    function generateDemoData() {
      const fieldId = document.getElementById('chartFieldSelect').value;
      
      if (!fieldId) {
        alert('è¯·å…ˆé€‰æ‹©åœ°å—');
        return;
      }
      
      if (!confirm('ç¡®å®šè¦ä¸ºè¯¥åœ°å—ç”Ÿæˆæ¼”ç¤ºæ•°æ®å—ï¼Ÿè¿™å°†æ·»åŠ 7å¤©çš„æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®ã€‚')) {
        return;
      }
      
      document.getElementById('chartLoadingMessage').innerHTML = 
        '<p><span class="loading-spinner"></span> æ­£åœ¨ç”Ÿæˆæ¼”ç¤ºæ•°æ®...</p>';
      document.getElementById('chartLoadingMessage').style.display = 'block';
      
      fetch('/api/generate_demo_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          field_id: parseInt(fieldId),
          days: 7
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('chartLoadingMessage').innerHTML = 
              `<p style="color: var(--bg-accent1);">âœ… ${data.message}</p>`;
            // è‡ªåŠ¨åŠ è½½å›¾è¡¨
            setTimeout(() => {
              loadChartData();
            }, 1000);
          } else {
            document.getElementById('chartLoadingMessage').innerHTML = 
              `<p>âŒ ç”Ÿæˆå¤±è´¥: ${data.message}</p>`;
          }
        })
        .catch(error => {
          console.error('ç”Ÿæˆæ¼”ç¤ºæ•°æ®å¤±è´¥:', error);
          document.getElementById('chartLoadingMessage').innerHTML = 
            '<p>âŒ ç”Ÿæˆæ¼”ç¤ºæ•°æ®å¤±è´¥</p>';
        });
    }

    // å¼‚å¸¸æ£€æµ‹ä¸é¢„è­¦ç›¸å…³å‡½æ•°
    let autoCheckInterval = null;
    
    function checkFieldAlerts() {
      const fieldId = document.getElementById('alertFieldSelect').value;
      
      if (!fieldId) {
        updateAlertStatus('error', 'âŒ', 'è¯·é€‰æ‹©åœ°å—', 'è¯·å…ˆé€‰æ‹©è¦æ£€æŸ¥çš„åœ°å—');
        return;
      }
      
      updateAlertStatus('loading', 'ğŸ”', 'æ£€æŸ¥ä¸­...', 'æ­£åœ¨åˆ†æä¼ æ„Ÿå™¨æ•°æ®...');
      
      fetch(`/api/check_field_alerts?field_id=${fieldId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            displayAlertResults(data);
          } else if (data.status === 'no_data') {
            updateAlertStatus('info', 'â„¹ï¸', 'æ— æ•°æ®', data.message);
            document.getElementById('alertDetails').innerHTML = 
              '<p style="color: #333; text-align: center; padding: 20px;">è¯¥åœ°å—æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæ— æ³•è¿›è¡Œå¼‚å¸¸æ£€æµ‹</p>';
            document.getElementById('alertRecommendations').innerHTML = 
              '<div class="recommendation-item">å»ºè®®å…ˆå½•å…¥ä¸€äº›ä¼ æ„Ÿå™¨æ•°æ®æˆ–ç”Ÿæˆæ¼”ç¤ºæ•°æ®</div>';
          } else {
            updateAlertStatus('error', 'âŒ', 'æ£€æŸ¥å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
          }
        })
        .catch(error => {
          console.error('æ£€æŸ¥é¢„è­¦å¤±è´¥:', error);
          updateAlertStatus('error', 'âŒ', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        });
    }
    
    function displayAlertResults(data) {
      const summary = data.alert_summary;
      const anomalies = data.all_anomalies || [];
      
      // æ›´æ–°çŠ¶æ€å¡ç‰‡
      const level = summary.max_level;
      const icon = summary.alert_info.icon;
      const statusText = summary.total_alerts === 0 ? 'æ­£å¸¸' : `${summary.total_alerts}ä¸ªå¼‚å¸¸`;
      
      updateAlertStatus(level, icon, statusText, summary.summary);
      
      // æ˜¾ç¤ºè¯¦ç»†å¼‚å¸¸ä¿¡æ¯
      displayAlertDetails(anomalies);
      
      // æ˜¾ç¤ºå¤„ç†å»ºè®®
      displayRecommendations(summary.recommendations);
    }
    
    function updateAlertStatus(level, icon, title, message) {
      const statusCard = document.getElementById('alertStatusCard');
      const statusIcon = statusCard.querySelector('.status-icon');
      const statusTitle = statusCard.querySelector('.status-text h4');
      const statusMessage = statusCard.querySelector('.status-text p');
      
      // ç§»é™¤æ‰€æœ‰ç­‰çº§ç±»
      statusCard.className = 'alert-status-card';
      if (level !== 'loading' && level !== 'error') {
        statusCard.classList.add(level);
      }
      
      statusIcon.textContent = icon;
      statusTitle.textContent = title;
      statusMessage.textContent = message;
    }
    
    function displayAlertDetails(anomalies) {
      const detailsContainer = document.getElementById('alertDetails');
      
      if (anomalies.length === 0) {
        detailsContainer.innerHTML = 
          '<p style="color: var(--bg-accent1); text-align: center; padding: 20px;">âœ… æ‰€æœ‰å‚æ•°æ­£å¸¸ï¼Œæœªå‘ç°å¼‚å¸¸</p>';
        return;
      }
      
      let html = '';
      anomalies.forEach(anomaly => {
        const level = anomaly.level || 'info';
        const icon = getAlertIcon(level);
        const parameterName = getParameterDisplayName(anomaly.parameter);
        
        html += `
          <div class="alert-item ${level}">
            <div class="alert-icon">${icon}</div>
            <div class="alert-content">
              <h5>${parameterName}</h5>
              <p>${anomaly.message}</p>
              ${anomaly.value !== undefined ? `<span class="alert-value">å½“å‰å€¼: ${anomaly.value}</span>` : ''}
            </div>
          </div>
        `;
      });
      
      detailsContainer.innerHTML = html;
    }
    
    function displayRecommendations(recommendations) {
      const recommendationsContainer = document.getElementById('alertRecommendations');
      
      if (!recommendations || recommendations.length === 0) {
        recommendationsContainer.innerHTML = 
          '<p style="color: #333; text-align: center; padding: 20px;">æš‚æ— ç‰¹æ®Šå»ºè®®</p>';
        return;
      }
      
      let html = '';
      recommendations.forEach(recommendation => {
        if (recommendation.trim()) {
          html += `<div class="recommendation-item">ğŸ’¡ ${recommendation}</div>`;
        }
      });
      
      recommendationsContainer.innerHTML = html || 
        '<p style="color: #333; text-align: center; padding: 20px;">æš‚æ— ç‰¹æ®Šå»ºè®®</p>';
    }
    
    function getAlertIcon(level) {
      const icons = {
        'info': 'â„¹ï¸',
        'warning': 'âš ï¸',
        'danger': 'ğŸš¨',
        'critical': 'ğŸ’€'
      };
      return icons[level] || 'â„¹ï¸';
    }
    
    function getParameterDisplayName(parameter) {
      const names = {
        'temperature': 'æ¸©åº¦',
        'humidity': 'æ¹¿åº¦',
        'soil_moisture': 'åœŸå£¤æ¹¿åº¦',
        'ph_value': 'pHå€¼',
        'light_intensity': 'å…‰ç…§å¼ºåº¦',
        'nitrogen': 'æ°®å«é‡',
        'phosphorus': 'ç£·å«é‡',
        'potassium': 'é’¾å«é‡'
      };
      return names[parameter] || parameter;
    }
    
    function enableAutoCheck() {
      const btn = document.getElementById('autoCheckBtn');
      
      if (autoCheckInterval) {
        // åœæ­¢è‡ªåŠ¨æ£€æŸ¥
        clearInterval(autoCheckInterval);
        autoCheckInterval = null;
        btn.textContent = 'ğŸ”„ å¯ç”¨è‡ªåŠ¨æ£€æµ‹';
        btn.style.background = '#2196f3';
      } else {
        // å¯åŠ¨è‡ªåŠ¨æ£€æŸ¥
        const fieldId = document.getElementById('alertFieldSelect').value;
        if (!fieldId) {
          alert('è¯·å…ˆé€‰æ‹©åœ°å—');
          return;
        }
        
        autoCheckInterval = setInterval(() => {
          checkFieldAlerts();
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        
        btn.textContent = 'â¹ï¸ åœæ­¢è‡ªåŠ¨æ£€æµ‹';
        btn.style.background = '#dc3545';
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
        checkFieldAlerts();
      }
    }
    
    function refreshAlerts() {
      checkFieldAlerts();
    }
    
    // åœ¨ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜åè‡ªåŠ¨æ£€æŸ¥å¼‚å¸¸
    function saveSensorDataWithAlert() {
      const fieldId = document.getElementById('sensorFieldSelect').value;
      if (!fieldId) {
        showNotification('è¯·å…ˆé€‰æ‹©åœ°å—', 'error');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦è‡³å°‘å¡«å†™äº†ä¸€ä¸ªä¼ æ„Ÿå™¨æ•°æ®
      const inputs = [
        'temperature', 'humidity', 'soilMoisture', 'lightIntensity',
        'phValue', 'nitrogen', 'phosphorus', 'potassium'
      ];
      
      const hasData = inputs.some(id => {
        const value = document.getElementById(id).value;
        return value && value.trim() !== '';
      });

      if (!hasData) {
        showNotification('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªä¼ æ„Ÿå™¨æ•°æ®', 'warning');
        return;
      }

      const data = {
        field_id: parseInt(fieldId),
        crop_type: document.getElementById('sensorCropSelect').value,
        growth_stage: document.getElementById('sensorStageSelect').value,
        temperature: document.getElementById('temperature').value || null,
        humidity: document.getElementById('humidity').value || null,
        soil_moisture: document.getElementById('soilMoisture').value || null,
        light_intensity: document.getElementById('lightIntensity').value || null,
        ph_value: document.getElementById('phValue').value || null,
        nitrogen: document.getElementById('nitrogen').value || null,
        phosphorus: document.getElementById('phosphorus').value || null,
        potassium: document.getElementById('potassium').value || null,
        location: document.getElementById('location').value || null
      };

      // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
      const resultDiv = document.getElementById('sensorResult');
      resultDiv.innerHTML = '<p><span class="loading-spinner"></span> æ­£åœ¨ä¿å­˜æ•°æ®...</p>';

      fetch('/api/save_sensor_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.status === 'success') {
            resultDiv.innerHTML = 
              '<div class="success">âœ… ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜æˆåŠŸï¼ID: ' + result.data_id + '</div>';
            
            showNotification('ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜æˆåŠŸ', 'success');
            
            // è‡ªåŠ¨æ£€æŸ¥å¼‚å¸¸
            checkSensorDataAnomalies(data);
          } else {
            resultDiv.innerHTML = 
              '<div class="error">âŒ ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
            showNotification('ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          resultDiv.innerHTML = 
            '<div class="error">âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>';
          showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
        });
    }
    
    function checkSensorDataAnomalies(sensorData) {
      const cropType = sensorData.crop_type || 'æ°´ç¨»';
      
      fetch('/api/check_sensor_anomalies', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          sensor_data: sensorData,
          crop_type: cropType
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.anomalies.length > 0) {
            const summary = data.alert_summary;
            const alertHtml = `
              <div class="alert-item ${summary.max_level}" style="margin-top: 10px;">
                <div class="alert-icon">${getAlertIcon(summary.max_level)}</div>
                <div class="alert-content">
                  <h5>å¼‚å¸¸æ£€æµ‹ç»“æœ</h5>
                  <p>${summary.summary}</p>
                </div>
              </div>
            `;
            document.getElementById('sensorResult').innerHTML += alertHtml;
          }
        })
        .catch(error => {
          console.error('å¼‚å¸¸æ£€æµ‹å¤±è´¥:', error);
        });
    }

    // é¡µé¢åŠ è½½æ—¶å…ˆæ‹‰å–ç”¨æˆ·ï¼Œå†åŠ è½½åœ°å—
    window.addEventListener('DOMContentLoaded', function() {
      loadUsers();
      addInputValidation();
      addTooltips();
    });

    // æ·»åŠ è¾“å…¥éªŒè¯
    function addInputValidation() {
      const inputs = document.querySelectorAll('input[type="number"]');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          validateInput(this);
        });
        input.addEventListener('blur', function() {
          validateInput(this);
        });
      });
    }

    // éªŒè¯è¾“å…¥å€¼
    function validateInput(input) {
      const value = parseFloat(input.value);
      if (isNaN(value)) return;

      const ranges = {
        'temperature': { min: -10, max: 50, optimal: [15, 35] },
        'humidity': { min: 0, max: 100, optimal: [40, 95] },
        'soilMoisture': { min: 0, max: 100, optimal: [50, 95] },
        'lightIntensity': { min: 0, max: 150000, optimal: [10000, 120000] },
        'phValue': { min: 3, max: 10, optimal: [5.5, 8.0] },
        'nitrogen': { min: 0, max: 500, optimal: [80, 300] },
        'phosphorus': { min: 0, max: 300, optimal: [30, 180] },
        'potassium': { min: 0, max: 400, optimal: [60, 250] }
      };

      const range = ranges[input.id];
      if (!range) return;

      // ç§»é™¤ä¹‹å‰çš„æ ·å¼
      input.classList.remove('input-warning', 'input-danger', 'input-success');

      if (value < range.min || value > range.max) {
        input.classList.add('input-danger');
        showInputFeedback(input, 'æ•°å€¼è¶…å‡ºåˆç†èŒƒå›´', 'danger');
      } else if (value < range.optimal[0] || value > range.optimal[1]) {
        input.classList.add('input-warning');
        showInputFeedback(input, 'æ•°å€¼åç¦»æœ€é€‚èŒƒå›´', 'warning');
      } else {
        input.classList.add('input-success');
        showInputFeedback(input, 'æ•°å€¼æ­£å¸¸', 'success');
      }
    }

    // æ˜¾ç¤ºè¾“å…¥åé¦ˆ
    function showInputFeedback(input, message, type) {
      // ç§»é™¤ç°æœ‰çš„åé¦ˆ
      const existingFeedback = input.parentNode.querySelector('.input-feedback');
      if (existingFeedback) {
        existingFeedback.remove();
      }

      // æ·»åŠ æ–°çš„åé¦ˆ
      const feedback = document.createElement('div');
      feedback.className = `input-feedback input-feedback-${type}`;
      feedback.textContent = message;
      feedback.style.fontSize = '12px';
      feedback.style.marginTop = '4px';
      feedback.style.padding = '4px 8px';
      feedback.style.borderRadius = '4px';
      
      if (type === 'danger') {
        feedback.style.color = '#d32f2f';
        feedback.style.background = '#ffebee';
      } else if (type === 'warning') {
        feedback.style.color = '#f57c00';
        feedback.style.background = '#fff8e1';
      } else if (type === 'success') {
        feedback.style.color = '#2E7D32';
        feedback.style.background = '#ffffff';
      }

      input.parentNode.appendChild(feedback);

      // 3ç§’åè‡ªåŠ¨ç§»é™¤æˆåŠŸæ¶ˆæ¯
      if (type === 'success') {
        setTimeout(() => {
          if (feedback.parentNode) {
            feedback.remove();
          }
        }, 3000);
      }
    }

    // æ¸…ç©ºä¼ æ„Ÿå™¨æ•°æ®
    function clearSensorData() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®å—ï¼Ÿ')) {
        return;
      }

      const inputs = [
        'temperature', 'humidity', 'soilMoisture', 'lightIntensity',
        'phValue', 'nitrogen', 'phosphorus', 'potassium', 'location'
      ];

      inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.value = '';
          input.classList.remove('input-warning', 'input-danger', 'input-success');
          // ç§»é™¤åé¦ˆæ¶ˆæ¯
          const feedback = input.parentNode.querySelector('.input-feedback');
          if (feedback) {
            feedback.remove();
          }
        }
      });

      document.getElementById('sensorResult').innerHTML = '';
      
      // æ˜¾ç¤ºæ¸…ç©ºæˆåŠŸæ¶ˆæ¯
      showNotification('ä¼ æ„Ÿå™¨æ•°æ®å·²æ¸…ç©º', 'success');
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <span>${getNotificationIcon(type)}</span>
          <span>${message}</span>
        </div>
      `;
      
      // æ ·å¼
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
      `;

      if (type === 'success') {
        notification.style.background = 'linear-gradient(135deg, #ffffff, #2E7D32)';
        notification.style.color = '#2c2c2c';
        notification.style.border = '1px solid #2E7D32';
      } else if (type === 'error') {
        notification.style.background = 'linear-gradient(135deg, #ffebee, #fce4ec)';
        notification.style.color = '#d32f2f';
        notification.style.border = '1px solid #ffcdd2';
      } else if (type === 'warning') {
        notification.style.background = 'linear-gradient(135deg, #fff8e1, #fffde7)';
        notification.style.color = '#f57c00';
        notification.style.border = '1px solid #ffecb3';
      } else {
        notification.style.background = 'linear-gradient(135deg, #e3f2fd, #f3e5f5)';
        notification.style.color = '#1976d2';
        notification.style.border = '1px solid #bbdefb';
      }

      document.body.appendChild(notification);

      // è‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, duration);
    }

    function getNotificationIcon(type) {
      const icons = {
        'success': 'âœ…',
        'error': 'âŒ',
        'warning': 'âš ï¸',
        'info': 'â„¹ï¸'
      };
      return icons[type] || 'â„¹ï¸';
    }

    // æ·»åŠ å·¥å…·æç¤º
    function addTooltips() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„å·¥å…·æç¤ºåŠŸèƒ½
    }
  </script>
</body>
</html>

