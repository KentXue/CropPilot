<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œç‰©ç”Ÿé•¿çŠ¶æ€ç®¡ç†ä¸å†³ç­–æ”¯æŒç³»ç»Ÿ</title>
  <!-- Chart.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    h2, h3 {
      color: #555;
      margin: 20px 0 15px 0;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .form-group {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    label {
      min-width: 100px;
      font-weight: bold;
      color: #333;
    }
    select, input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      flex: 1;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result-box {
      border: 2px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      background: white;
      min-height: 100px;
      margin-top: 15px;
    }
    .advice-item {
      padding: 10px;
      margin: 8px 0;
      background: #e8f4f8;
      border-left: 3px solid #667eea;
      border-radius: 4px;
    }
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .sensor-input {
      display: flex;
      flex-direction: column;
    }
    .sensor-input label {
      min-width: auto;
      margin-bottom: 5px;
      font-size: 13px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: none;
      border: none;
      color: #666;
      font-size: 16px;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      color: #2e7d32;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      border-left: 4px solid #667eea;
    }
    .stat-card h4 {
      margin: 0 0 10px 0;
      color: #555;
      font-size: 14px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .alert-overview {
      margin: 20px 0;
    }
    .alert-status-card {
      display: flex;
      align-items: center;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #6c757d;
    }
    .alert-status-card.info {
      border-left-color: #17a2b8;
      background: #e8f4f8;
    }
    .alert-status-card.warning {
      border-left-color: #ffc107;
      background: #fff8e1;
    }
    .alert-status-card.danger {
      border-left-color: #dc3545;
      background: #ffebee;
    }
    .alert-status-card.critical {
      border-left-color: #6f42c1;
      background: #f3e5f5;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    .status-icon {
      font-size: 48px;
      margin-right: 20px;
    }
    .status-text h4 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .status-text p {
      margin: 0;
      color: #666;
    }
    .alert-details {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .alert-item {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid #ddd;
    }
    .alert-item.warning {
      background: #fff8e1;
      border-left-color: #ffc107;
    }
    .alert-item.danger {
      background: #ffebee;
      border-left-color: #dc3545;
    }
    .alert-item.critical {
      background: #f3e5f5;
      border-left-color: #6f42c1;
    }
    .alert-icon {
      font-size: 24px;
      margin-right: 15px;
    }
    .alert-content {
      flex: 1;
    }
    .alert-content h5 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .alert-content p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .alert-value {
      font-weight: bold;
      color: #333;
      margin-left: 10px;
    }
    .alert-recommendations {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .recommendation-item {
      padding: 12px;
      margin: 8px 0;
      background: #e8f5e9;
      border-left: 3px solid #28a745;
      border-radius: 4px;
    }
    .threshold-info {
      margin-top: 15px;
    }
    .threshold-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .threshold-card h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
    }
    .threshold-card p {
      margin: 5px 0;
      font-size: 13px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ¾ ä½œç‰©ç”Ÿé•¿çŠ¶æ€ç®¡ç†ä¸å†³ç­–æ”¯æŒç³»ç»Ÿ</h1>
    
    <div class="section" style="margin-top:10px;">
      <h3>ğŸ‘¤ é€‰æ‹©ç”¨æˆ·ï¼ˆæ¼”ç¤ºç”¨ï¼‰</h3>
      <div class="form-group">
        <label>ç”¨æˆ·ï¼š</label>
        <select id="userSelect">
          <option value="">å…¨éƒ¨ç”¨æˆ·</option>
        </select>
        <small style="color:#777;">é€‰æ‹©ç”¨æˆ·åå°†åªæ˜¾ç¤ºå…¶åœ°å—</small>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('advice')">å†œäº‹å»ºè®®</button>
      <button class="tab" onclick="switchTab('smart')">æ™ºèƒ½å’¨è¯¢</button>
      <button class="tab" onclick="switchTab('sensor')">ä¼ æ„Ÿå™¨æ•°æ®</button>
      <button class="tab" onclick="switchTab('charts')">æ•°æ®å¯è§†åŒ–</button>
      <button class="tab" onclick="switchTab('alerts')">å¼‚å¸¸é¢„è­¦</button>
      <button class="tab" onclick="switchTab('history')">å†å²è®°å½•</button>
    </div>

    <!-- å†œäº‹å»ºè®®æ ‡ç­¾é¡µ -->
    <div id="advice-tab" class="tab-content active">
      <div class="section">
        <h2>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åœ°å— / ä½œç‰© / ç”Ÿé•¿é˜¶æ®µ</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="fieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
          <small style="color:#777;">(æ¨è) é€‰æ‹©åœ°å—åè‡ªåŠ¨å¸¦å‡ºä½œç‰©</small>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="cropSelect">
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="stageSelect">
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
          
          <button onclick="getAdvice()">è·å–å†œäº‹å»ºè®®</button>
        </div>
      </div>
      
      <div class="section">
        <h3>ğŸ’¡ ç³»ç»Ÿå»ºè®®</h3>
        <div id="adviceResult" class="result-box">
          <p style="color: #999;">å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>
    </div>

    <!-- æ™ºèƒ½å’¨è¯¢æ ‡ç­¾é¡µ -->
    <div id="smart-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ¤– æ™ºèƒ½å†œä¸šå’¨è¯¢</h2>
        <p style="color:#777; margin-bottom:15px;">åŸºäºå†œä¸šçŸ¥è¯†åº“çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢</p>
        
        <div class="form-group">
          <label>é€‰æ‹©åœ°å—ï¼š</label>
          <select id="smartFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—ï¼ˆå¯é€‰ï¼‰</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>å’¨è¯¢é—®é¢˜ï¼š</label>
          <textarea id="smartQuestion" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;" 
                    placeholder="ä¾‹å¦‚ï¼šæ°´ç¨»å¶å­å‘é»„æ€ä¹ˆåŠï¼Ÿç‰ç±³æ‹”èŠ‚æœŸå¦‚ä½•æ–½è‚¥ï¼Ÿé«˜æ¸©å¤©æ°”æ³¨æ„ä»€ä¹ˆï¼Ÿ"></textarea>
        </div>
        
        <div style="margin-top: 15px;">
          <button onclick="getSmartAdvice()" style="background: #28a745;">ğŸ” æ™ºèƒ½å’¨è¯¢</button>
          <button onclick="clearSmartQuery()" style="background: #6c757d; margin-left: 10px;">æ¸…ç©º</button>
        </div>
        
        <div class="section" style="margin-top: 20px;">
          <h3>ğŸ’¡ æ™ºèƒ½å»ºè®®</h3>
          <div id="smartResult" class="result-box">
            <p style="color: #999;">æ™ºèƒ½å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
          </div>
        </div>
        
        <div class="section" style="background: #f8f9fa; border-left-color: #17a2b8;">
          <h3>ğŸ’¬ å¸¸è§é—®é¢˜ç¤ºä¾‹</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <button onclick="setSmartQuestion('å¶å­å‘é»„æ€ä¹ˆåŠ')" style="background: #17a2b8; font-size: 12px;">å¶å­å‘é»„æ€ä¹ˆåŠ</button>
            <button onclick="setSmartQuestion('å¦‚ä½•é˜²æ²»ç—…è™«å®³')" style="background: #17a2b8; font-size: 12px;">å¦‚ä½•é˜²æ²»ç—…è™«å®³</button>
            <button onclick="setSmartQuestion('é«˜æ¸©å¹²æ—±åº”å¯¹æªæ–½')" style="background: #17a2b8; font-size: 12px;">é«˜æ¸©å¹²æ—±åº”å¯¹</button>
            <button onclick="setSmartQuestion('åœŸå£¤pHå€¼è°ƒèŠ‚')" style="background: #17a2b8; font-size: 12px;">åœŸå£¤pHè°ƒèŠ‚</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¼ æ„Ÿå™¨æ•°æ®æ ‡ç­¾é¡µ -->
    <div id="sensor-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“Š å½•å…¥ä¼ æ„Ÿå™¨æ•°æ®</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="sensorFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="sensorCropSelect">
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="sensorStageSelect">
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
        </div>

        <div class="section" style="background: #fff; border-left-color: #28a745; border: 1px solid #e5e5e5; margin-top: 10px;">
          <h3>ğŸ–¼ ä¸Šä¼ ä½œç‰©å›¾ç‰‡</h3>
          <p style="color:#777; margin-bottom:10px;">å…ˆé€‰æ‹©ä¸Šæ–¹åœ°å—ï¼Œå†ä¸Šä¼ å›¾ç‰‡ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°ç³»ç»Ÿå¹¶è®°å½•è·¯å¾„ä¸æ—¶é—´ï¼‰ã€‚</p>
          <div class="form-group">
            <label>æ‹æ‘„æ—¶é—´ï¼š</label>
            <input type="datetime-local" id="capturedAt">
          </div>
          <div class="form-group">
            <label>ä½œç‰©å›¾ç‰‡ï¼š</label>
            <input type="file" id="cropImageFile" accept="image/*" style="flex:1;">
            <button onclick="uploadCropImage()" style="margin-left:10px;">ä¸Šä¼ ä½œç‰©å›¾ç‰‡</button>
          </div>
          <div id="uploadResult"></div>
        </div>
        
        <div class="sensor-grid">
          <div class="sensor-input">
            <label>æ¸©åº¦ (Â°C):</label>
            <input type="number" id="temperature" step="0.1" placeholder="ä¾‹å¦‚: 25.5">
          </div>
          <div class="sensor-input">
            <label>æ¹¿åº¦ (%):</label>
            <input type="number" id="humidity" step="0.1" placeholder="ä¾‹å¦‚: 65.0">
          </div>
          <div class="sensor-input">
            <label>åœŸå£¤æ¹¿åº¦ (%):</label>
            <input type="number" id="soilMoisture" step="0.1" placeholder="ä¾‹å¦‚: 70.0">
          </div>
          <div class="sensor-input">
            <label>å…‰ç…§å¼ºåº¦ (lux):</label>
            <input type="number" id="lightIntensity" step="0.1" placeholder="ä¾‹å¦‚: 50000">
          </div>
          <div class="sensor-input">
            <label>pHå€¼:</label>
            <input type="number" id="phValue" step="0.1" placeholder="ä¾‹å¦‚: 6.5">
          </div>
          <div class="sensor-input">
            <label>æ°®å«é‡ (mg/kg):</label>
            <input type="number" id="nitrogen" step="0.1" placeholder="ä¾‹å¦‚: 150.0">
          </div>
          <div class="sensor-input">
            <label>ç£·å«é‡ (mg/kg):</label>
            <input type="number" id="phosphorus" step="0.1" placeholder="ä¾‹å¦‚: 80.0">
          </div>
          <div class="sensor-input">
            <label>é’¾å«é‡ (mg/kg):</label>
            <input type="number" id="potassium" step="0.1" placeholder="ä¾‹å¦‚: 120.0">
          </div>
          <div class="sensor-input">
            <label>ä½ç½®/åœ°å—:</label>
            <input type="text" id="location" placeholder="ä¾‹å¦‚: AåŒº-1å·ç”°">
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <button onclick="saveSensorData()">ä¿å­˜ä¼ æ„Ÿå™¨æ•°æ®</button>
          <button onclick="getAdviceWithSensor()" style="background: #28a745; margin-left: 10px;">åŸºäºæ•°æ®è·å–å»ºè®®</button>
        </div>
        
        <div id="sensorResult"></div>
      </div>
    </div>

    <!-- æ•°æ®å¯è§†åŒ–æ ‡ç­¾é¡µ -->
    <div id="charts-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“Š æ•°æ®å¯è§†åŒ–åˆ†æ</h2>
        <p style="color:#777; margin-bottom:15px;">ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿å›¾è¡¨å’Œç»Ÿè®¡åˆ†æ</p>
        
        <div class="form-group">
          <label>é€‰æ‹©åœ°å—ï¼š</label>
          <select id="chartFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
          <label>æ—¶é—´èŒƒå›´ï¼š</label>
          <select id="chartTimeRange">
            <option value="7">æœ€è¿‘7å¤©</option>
            <option value="30">æœ€è¿‘30å¤©</option>
            <option value="90">æœ€è¿‘90å¤©</option>
          </select>
          <button onclick="loadChartData()" style="background: #17a2b8;">ğŸ“ˆ åŠ è½½å›¾è¡¨</button>
          <button onclick="refreshCharts()" style="background: #28a745; margin-left: 10px;">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div class="form-group" style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
          <label style="color: #856404;">æ¼”ç¤ºåŠŸèƒ½ï¼š</label>
          <button onclick="generateDemoData()" style="background: #ffc107; color: #212529;">ğŸ² ç”Ÿæˆæ¼”ç¤ºæ•°æ®</button>
          <small style="color: #856404; margin-left: 10px;">ä¸ºé€‰ä¸­çš„åœ°å—ç”Ÿæˆ7å¤©çš„æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®ç”¨äºå›¾è¡¨æ¼”ç¤º</small>
        </div>
      </div>

      <!-- å›¾è¡¨å®¹å™¨ -->
      <div class="section">
        <h3>ğŸŒ¡ï¸ ç¯å¢ƒå‚æ•°è¶‹åŠ¿å›¾</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">æ¸©åº¦ & æ¹¿åº¦è¶‹åŠ¿</h4>
            <canvas id="tempHumidityChart" width="400" height="200"></canvas>
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">åœŸå£¤æ¹¿åº¦ & pHå€¼</h4>
            <canvas id="soilChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ğŸŒ± è¥å…»å…ƒç´ åˆ†æ</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">NPKè¥å…»å…ƒç´ è¶‹åŠ¿</h4>
            <canvas id="nutrientChart" width="400" height="200"></canvas>
          </div>
          <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="text-align: center; margin-bottom: 15px; color: #333;">å…‰ç…§å¼ºåº¦å˜åŒ–</h4>
            <canvas id="lightChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ğŸ“ˆ æ•°æ®ç»Ÿè®¡æ‘˜è¦</h3>
        <div id="chartSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="stat-card">
            <h4>æ¸©åº¦</h4>
            <div class="stat-value" id="tempStats">--</div>
          </div>
          <div class="stat-card">
            <h4>æ¹¿åº¦</h4>
            <div class="stat-value" id="humidityStats">--</div>
          </div>
          <div class="stat-card">
            <h4>åœŸå£¤æ¹¿åº¦</h4>
            <div class="stat-value" id="soilMoistureStats">--</div>
          </div>
          <div class="stat-card">
            <h4>pHå€¼</h4>
            <div class="stat-value" id="phStats">--</div>
          </div>
        </div>
      </div>

      <div id="chartLoadingMessage" style="text-align: center; padding: 40px; color: #999;">
        <p>ğŸ“Š é€‰æ‹©åœ°å—å¹¶ç‚¹å‡»"åŠ è½½å›¾è¡¨"æŸ¥çœ‹æ•°æ®å¯è§†åŒ–</p>
      </div>
    </div>

    <!-- å¼‚å¸¸é¢„è­¦æ ‡ç­¾é¡µ -->
    <div id="alerts-tab" class="tab-content">
      <div class="section">
        <h2>ğŸš¨ å¼‚å¸¸æ£€æµ‹ä¸é¢„è­¦</h2>
        <p style="color:#777; margin-bottom:15px;">å®æ—¶ç›‘æµ‹ä¼ æ„Ÿå™¨æ•°æ®å¼‚å¸¸ï¼Œæä¾›æ™ºèƒ½é¢„è­¦å’Œå¤„ç†å»ºè®®</p>
        
        <div class="form-group">
          <label>é€‰æ‹©åœ°å—ï¼š</label>
          <select id="alertFieldSelect">
            <option value="">è¯·é€‰æ‹©åœ°å—</option>
          </select>
          <button onclick="checkFieldAlerts()" style="background: #dc3545;">ğŸ” æ£€æŸ¥é¢„è­¦</button>
          <button onclick="refreshAlerts()" style="background: #28a745; margin-left: 10px;">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div class="form-group" style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
          <label style="color: #1565c0;">å®æ—¶æ£€æµ‹ï¼š</label>
          <button onclick="enableAutoCheck()" id="autoCheckBtn" style="background: #2196f3; color: white;">ğŸ”„ å¯ç”¨è‡ªåŠ¨æ£€æµ‹</button>
          <small style="color: #1565c0; margin-left: 10px;">æ¯30ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡é¢„è­¦çŠ¶æ€</small>
        </div>
      </div>

      <!-- é¢„è­¦çŠ¶æ€æ¦‚è§ˆ -->
      <div class="section">
        <h3>ğŸ“Š é¢„è­¦çŠ¶æ€æ¦‚è§ˆ</h3>
        <div id="alertOverview" class="alert-overview">
          <div class="alert-status-card" id="alertStatusCard">
            <div class="status-icon">ğŸ”</div>
            <div class="status-text">
              <h4>ç­‰å¾…æ£€æµ‹</h4>
              <p>è¯·é€‰æ‹©åœ°å—å¹¶ç‚¹å‡»"æ£€æŸ¥é¢„è­¦"</p>
            </div>
          </div>
        </div>
      </div>

      <!-- è¯¦ç»†é¢„è­¦ä¿¡æ¯ -->
      <div class="section">
        <h3>âš ï¸ è¯¦ç»†é¢„è­¦ä¿¡æ¯</h3>
        <div id="alertDetails" class="alert-details">
          <p style="color: #999; text-align: center; padding: 20px;">é¢„è­¦è¯¦æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>

      <!-- å¤„ç†å»ºè®® -->
      <div class="section">
        <h3>ğŸ’¡ å¤„ç†å»ºè®®</h3>
        <div id="alertRecommendations" class="alert-recommendations">
          <p style="color: #999; text-align: center; padding: 20px;">å¤„ç†å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>

      <!-- å‚æ•°é˜ˆå€¼è®¾ç½® -->
      <div class="section" style="background: #f8f9fa; border-left-color: #6c757d;">
        <h3>âš™ï¸ é¢„è­¦é˜ˆå€¼å‚è€ƒ</h3>
        <div class="threshold-info">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="threshold-card">
              <h4>ğŸŒ¡ï¸ æ¸©åº¦èŒƒå›´</h4>
              <p><strong>æ°´ç¨»:</strong> 15-35Â°C (æœ€é€‚: 20-30Â°C)</p>
              <p><strong>ç‰ç±³:</strong> 10-40Â°C (æœ€é€‚: 18-32Â°C)</p>
            </div>
            <div class="threshold-card">
              <h4>ğŸ’§ æ¹¿åº¦èŒƒå›´</h4>
              <p><strong>æ°´ç¨»:</strong> 50-95% (æœ€é€‚: 60-85%)</p>
              <p><strong>ç‰ç±³:</strong> 40-85% (æœ€é€‚: 50-75%)</p>
            </div>
            <div class="threshold-card">
              <h4>ğŸŒ± åœŸå£¤æ¹¿åº¦</h4>
              <p><strong>æ°´ç¨»:</strong> 60-95% (æœ€é€‚: 70-90%)</p>
              <p><strong>ç‰ç±³:</strong> 50-85% (æœ€é€‚: 60-80%)</p>
            </div>
            <div class="threshold-card">
              <h4>âš—ï¸ pHå€¼èŒƒå›´</h4>
              <p><strong>æ°´ç¨»:</strong> 5.5-7.5 (æœ€é€‚: 6.0-7.0)</p>
              <p><strong>ç‰ç±³:</strong> 6.0-8.0 (æœ€é€‚: 6.5-7.5)</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å†å²è®°å½•æ ‡ç­¾é¡µ -->
    <div id="history-tab" class="tab-content">
      <div class="section">
        <h2>ğŸ“œ æŸ¥è¯¢å†å²è®°å½•</h2>
        <div class="form-group">
          <label>åœ°å—ï¼š</label>
          <select id="historyFieldSelect">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œç‰©ç±»å‹ï¼š</label>
          <select id="historyCropSelect">
            <option value="">å…¨éƒ¨</option>
            <option value="æ°´ç¨»">æ°´ç¨»</option>
            <option value="ç‰ç±³">ç‰ç±³</option>
          </select>
          
          <label>ç”Ÿé•¿é˜¶æ®µï¼š</label>
          <select id="historyStageSelect">
            <option value="">å…¨éƒ¨</option>
            <option value="åˆ†è˜–æœŸ">åˆ†è˜–æœŸ</option>
            <option value="æ‹”èŠ‚æœŸ">æ‹”èŠ‚æœŸ</option>
            <option value="æŠ½ç©—æœŸ">æŠ½ç©—æœŸ</option>
            <option value="æŠ½ç©—æ‰¬èŠ±æœŸ">æŠ½ç©—æ‰¬èŠ±æœŸ</option>
          </select>
          
          <button onclick="loadHistory()">æŸ¥è¯¢å†å²</button>
        </div>
        
        <div id="historyResult" class="result-box">
          <p style="color: #999;">å†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç®€å•çš„ç¼“å­˜
    let usersCache = [];
    let fieldsCache = [];
    let chartInstances = {}; // å­˜å‚¨å›¾è¡¨å®ä¾‹

    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(data => {
          if (data.status !== 'success') return;
          usersCache = data.users || [];
          const sel = document.getElementById('userSelect');
          if (sel) {
            const firstOption = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(firstOption);
            usersCache.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.id;
              opt.textContent = `${u.username} (${u.role})`;
              sel.appendChild(opt);
            });
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·å¹¶åŠ è½½å…¶åœ°å—
            if (usersCache.length > 0) {
              sel.value = usersCache[0].id;
              loadFields(usersCache[0].id);
            } else {
              loadFields();
            }
          }
        })
        .catch(err => console.error('åŠ è½½ç”¨æˆ·å¤±è´¥', err));
    }

    function loadFields(userId) {
      let url = '/api/fields';
      if (userId) {
        const params = new URLSearchParams();
        params.append('user_id', userId);
        url += `?${params.toString()}`;
      }
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.status !== 'success') return;
          fieldsCache = data.fields || [];
          const fieldSelectIds = ['fieldSelect', 'sensorFieldSelect', 'historyFieldSelect', 'smartFieldSelect'];
          fieldSelectIds.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            // å…ˆä¿ç•™ç¬¬ä¸€ä¸ªå ä½é¡¹
            const firstOption = sel.options[0];
            sel.innerHTML = '';
            sel.appendChild(firstOption);
            // å¦‚æœåˆ‡æ¢ç”¨æˆ·ï¼Œåˆ™é‡ç½®é€‰ä¸­é¡¹ä¸ºç©º
            sel.value = '';
            fieldsCache.forEach(f => {
              const opt = document.createElement('option');
              opt.value = f.id;
              opt.textContent = `${f.name} (${f.crop_type})`;
              sel.appendChild(opt);
            });
          });
        })
        .catch(err => console.error('åŠ è½½åœ°å—å¤±è´¥', err));
    }

    function getFieldById(fieldId) {
      return fieldsCache.find(f => String(f.id) === String(fieldId));
    }

    function switchTab(tabName) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„activeç±»
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
      });
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      document.getElementById(tabName + '-tab').classList.add('active');
      // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
      event.target.classList.add('active');
    }

    function getAdvice() {
      const fieldId = document.getElementById('fieldSelect').value;
      const crop = document.getElementById('cropSelect').value;
      const stage = document.getElementById('stageSelect').value;
      
      document.getElementById('adviceResult').innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';

      const params = new URLSearchParams();
      if (fieldId) params.append('field_id', fieldId);
      params.append('crop', crop);
      params.append('stage', stage);
      
      fetch(`/api/get_advice?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            let html = `<p style="font-size: 18px; margin-bottom: 15px;"><strong>${data.crop} - ${data.stage}</strong></p>`;
            if (data.advice && data.advice.length > 0) {
              data.advice.forEach(item => {
                html += `<div class="advice-item">${item}</div>`;
              });
            } else {
              html += '<p>æš‚æ— å»ºè®®</p>';
            }
            document.getElementById('adviceResult').innerHTML = html;
          } else {
            document.getElementById('adviceResult').innerHTML = '<div class="error">è·å–å»ºè®®å¤±è´¥</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('adviceResult').innerHTML = '<div class="error">è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ã€‚</div>';
        });
    }

    function uploadCropImage() {
      const fieldId = document.getElementById('sensorFieldSelect').value;
      const uploadResult = document.getElementById('uploadResult');
      const fileInput = document.getElementById('cropImageFile');
      const capturedAt = document.getElementById('capturedAt').value;

      if (!fieldId) {
        uploadResult.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©åœ°å—</div>';
        return;
      }

      if (!fileInput || fileInput.files.length === 0) {
        uploadResult.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡</div>';
        return;
      }

      const formData = new FormData();
      formData.append('field_id', fieldId);
      formData.append('image', fileInput.files[0]);
      if (capturedAt) {
        formData.append('captured_at', capturedAt);
      }

      uploadResult.innerHTML = '<p>æ­£åœ¨ä¸Šä¼ ...</p>';

      fetch('/api/upload_crop_image', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const link = data.image_path ? `<a href="${data.image_path}" target="_blank">æŸ¥çœ‹å›¾ç‰‡</a>` : '';
            uploadResult.innerHTML = `<div class="success">ä¸Šä¼ æˆåŠŸï¼${link}</div>`;
            fileInput.value = '';
          } else {
            uploadResult.innerHTML = `<div class="error">ä¸Šä¼ å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          uploadResult.innerHTML = '<div class="error">ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•ã€‚</div>';
        });
    }

    function saveSensorData() {
      saveSensorDataWithAlert();
    }

    function getAdviceWithSensor() {
      // å…ˆä¿å­˜æ•°æ®ï¼Œç„¶åç›´æ¥è·å–å½“å‰ä½œç‰©+é˜¶æ®µçš„å»ºè®®
      saveSensorData();
      getAdvice();
    }

    function loadHistory() {
      const fieldId = document.getElementById('historyFieldSelect').value;
      const crop = document.getElementById('historyCropSelect').value;
      const stage = document.getElementById('historyStageSelect').value;
      
      let url = '/api/get_history';
      const params = new URLSearchParams();
      if (fieldId) params.append('field_id', fieldId);
      if (crop) params.append('crop', crop);
      if (stage) params.append('stage', stage);
      if (params.toString()) url += '?' + params.toString();
      
      document.getElementById('historyResult').innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            let html = '<h3>å†³ç­–è®°å½• (' + data.count + ' æ¡)</h3>';
            if (data.records && data.records.length > 0) {
              data.records.forEach(record => {
                html += `<div class="advice-item" style="margin-bottom: 15px;">`;
                html += `<p><strong>${record.crop_type} - ${record.growth_stage}</strong></p>`;
                html += `<p>${record.advice}</p>`;
                html += `<p style="color: #999; font-size: 12px;">${record.created_at}</p>`;
                html += `</div>`;
              });
            } else {
              html += '<p>æš‚æ— å†å²è®°å½•</p>';
            }
            document.getElementById('historyResult').innerHTML = html;
          } else {
            document.getElementById('historyResult').innerHTML = 
              '<div class="error">æŸ¥è¯¢å¤±è´¥</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('historyResult').innerHTML = 
            '<div class="error">è¯·æ±‚å¤±è´¥</div>';
        });
    }

    // é€‰åœ°å—æ—¶è‡ªåŠ¨å¸¦å‡ºä½œç‰©ç±»å‹
    document.addEventListener('change', (e) => {
      if (e.target.id === 'userSelect') {
        const userId = e.target.value;
        loadFields(userId);
        return;
      }
      if (e.target.id === 'fieldSelect' || e.target.id === 'sensorFieldSelect') {
        const fieldId = e.target.value;
        const field = getFieldById(fieldId);
        if (field) {
          if (e.target.id === 'fieldSelect') {
            document.getElementById('cropSelect').value = field.crop_type;
          }
          if (e.target.id === 'sensorFieldSelect') {
            document.getElementById('sensorCropSelect').value = field.crop_type;
          }
        }
      }
    });

    function getSmartAdvice() {
      const fieldId = document.getElementById('smartFieldSelect').value;
      const question = document.getElementById('smartQuestion').value.trim();
      
      if (!question) {
        document.getElementById('smartResult').innerHTML = '<div class="error">è¯·è¾“å…¥å’¨è¯¢é—®é¢˜</div>';
        return;
      }
      
      document.getElementById('smartResult').innerHTML = '<p>ğŸ¤– æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...</p>';
      
      // è·å–åœ°å—ä¿¡æ¯ä»¥ç¡®å®šä½œç‰©ç±»å‹
      let cropType = '';
      let growthStage = '';
      if (fieldId) {
        const field = getFieldById(fieldId);
        if (field) {
          cropType = field.crop_type;
        }
      }
      
      const requestData = {
        question: question,
        crop_type: cropType,
        growth_stage: growthStage
      };
      
      fetch('/api/smart_advice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // æ ¼å¼åŒ–æ™ºèƒ½å»ºè®®æ˜¾ç¤º
            let html = `<div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
            html += `<h4 style="color: #2e7d32; margin: 0 0 10px 0;">ğŸ¤– æ™ºèƒ½åˆ†æç»“æœ</h4>`;
            html += `<p><strong>é—®é¢˜ï¼š</strong>${data.question}</p>`;
            if (data.crop_type) {
              html += `<p><strong>ä½œç‰©ï¼š</strong>${data.crop_type}</p>`;
            }
            html += `</div>`;
            
            // æ˜¾ç¤ºå»ºè®®å†…å®¹
            html += `<div style="white-space: pre-line; line-height: 1.6;">${data.advice}</div>`;
            
            document.getElementById('smartResult').innerHTML = html;
          } else {
            document.getElementById('smartResult').innerHTML = 
              `<div class="error">æ™ºèƒ½å’¨è¯¢å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
          }
        })
        .catch(error => {
          console.error('æ™ºèƒ½å’¨è¯¢é”™è¯¯:', error);
          document.getElementById('smartResult').innerHTML = 
            '<div class="error">ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥æˆ–ç¨åé‡è¯•</div>';
        });
    }
    
    function setSmartQuestion(question) {
      document.getElementById('smartQuestion').value = question;
    }
    
    function clearSmartQuery() {
      document.getElementById('smartQuestion').value = '';
      document.getElementById('smartResult').innerHTML = '<p style="color: #999;">æ™ºèƒ½å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>';
    }

    // æ•°æ®å¯è§†åŒ–ç›¸å…³å‡½æ•°
    function loadChartData() {
      const fieldId = document.getElementById('chartFieldSelect').value;
      const timeRange = document.getElementById('chartTimeRange').value;
      
      if (!fieldId) {
        document.getElementById('chartLoadingMessage').innerHTML = 
          '<p style="color: #d32f2f;">è¯·å…ˆé€‰æ‹©åœ°å—</p>';
        return;
      }
      
      document.getElementById('chartLoadingMessage').innerHTML = 
        '<p><span class="loading-spinner"></span> æ­£åœ¨åŠ è½½æ•°æ®...</p>';
      
      // è·å–ä¼ æ„Ÿå™¨æ•°æ®
      const params = new URLSearchParams();
      params.append('field_id', fieldId);
      params.append('limit', timeRange * 10); // å‡è®¾æ¯å¤©æœ‰å¤šæ¡æ•°æ®
      
      fetch(`/api/get_sensor_data?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.data && data.data.length > 0) {
            renderCharts(data.data);
            calculateStatistics(data.data);
            document.getElementById('chartLoadingMessage').style.display = 'none';
          } else {
            document.getElementById('chartLoadingMessage').innerHTML = 
              '<p style="color: #999;">ğŸ“Š è¯¥åœ°å—æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®</p>';
          }
        })
        .catch(error => {
          console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
          document.getElementById('chartLoadingMessage').innerHTML = 
            '<p style="color: #d32f2f;">âŒ æ•°æ®åŠ è½½å¤±è´¥</p>';
        });
    }
    
    function renderCharts(sensorData) {
      // å‡†å¤‡æ•°æ®
      const labels = sensorData.map(item => {
        const date = new Date(item.recorded_at);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
      }).reverse();
      
      const temperatures = sensorData.map(item => item.temperature).reverse();
      const humidities = sensorData.map(item => item.humidity).reverse();
      const soilMoistures = sensorData.map(item => item.soil_moisture).reverse();
      const phValues = sensorData.map(item => item.ph_value).reverse();
      const nitrogens = sensorData.map(item => item.nitrogen).reverse();
      const phosphorus = sensorData.map(item => item.phosphorus).reverse();
      const potassiums = sensorData.map(item => item.potassium).reverse();
      const lightIntensities = sensorData.map(item => item.light_intensity).reverse();
      
      // æ¸©åº¦æ¹¿åº¦å›¾è¡¨
      renderTempHumidityChart(labels, temperatures, humidities);
      
      // åœŸå£¤å›¾è¡¨
      renderSoilChart(labels, soilMoistures, phValues);
      
      // è¥å…»å…ƒç´ å›¾è¡¨
      renderNutrientChart(labels, nitrogens, phosphorus, potassiums);
      
      // å…‰ç…§å›¾è¡¨
      renderLightChart(labels, lightIntensities);
    }
    
    function renderTempHumidityChart(labels, temperatures, humidities) {
      const ctx = document.getElementById('tempHumidityChart').getContext('2d');
      
      // é”€æ¯ç°æœ‰å›¾è¡¨
      if (chartInstances.tempHumidity) {
        chartInstances.tempHumidity.destroy();
      }
      
      chartInstances.tempHumidity = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ¸©åº¦ (Â°C)',
            data: temperatures,
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'æ¹¿åº¦ (%)',
            data: humidities,
            borderColor: '#4ecdc4',
            backgroundColor: 'rgba(78, 205, 196, 0.1)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'æ¸©åº¦ (Â°C)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'æ¹¿åº¦ (%)'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    }
    
    function renderSoilChart(labels, soilMoistures, phValues) {
      const ctx = document.getElementById('soilChart').getContext('2d');
      
      if (chartInstances.soil) {
        chartInstances.soil.destroy();
      }
      
      chartInstances.soil = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'åœŸå£¤æ¹¿åº¦ (%)',
            data: soilMoistures,
            borderColor: '#45b7d1',
            backgroundColor: 'rgba(69, 183, 209, 0.1)',
            yAxisID: 'y'
          }, {
            label: 'pHå€¼',
            data: phValues,
            borderColor: '#f9ca24',
            backgroundColor: 'rgba(249, 202, 36, 0.1)',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'åœŸå£¤æ¹¿åº¦ (%)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'pHå€¼'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    }
    
    function renderNutrientChart(labels, nitrogens, phosphorus, potassiums) {
      const ctx = document.getElementById('nutrientChart').getContext('2d');
      
      if (chartInstances.nutrient) {
        chartInstances.nutrient.destroy();
      }
      
      chartInstances.nutrient = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ°® (mg/kg)',
            data: nitrogens,
            borderColor: '#6c5ce7',
            backgroundColor: 'rgba(108, 92, 231, 0.1)'
          }, {
            label: 'ç£· (mg/kg)',
            data: phosphorus,
            borderColor: '#a29bfe',
            backgroundColor: 'rgba(162, 155, 254, 0.1)'
          }, {
            label: 'é’¾ (mg/kg)',
            data: potassiums,
            borderColor: '#fd79a8',
            backgroundColor: 'rgba(253, 121, 168, 0.1)'
          }]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'å«é‡ (mg/kg)'
              }
            }
          }
        }
      });
    }
    
    function renderLightChart(labels, lightIntensities) {
      const ctx = document.getElementById('lightChart').getContext('2d');
      
      if (chartInstances.light) {
        chartInstances.light.destroy();
      }
      
      chartInstances.light = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å…‰ç…§å¼ºåº¦ (lux)',
            data: lightIntensities,
            borderColor: '#fdcb6e',
            backgroundColor: 'rgba(253, 203, 110, 0.1)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'æ—¶é—´'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'å…‰ç…§å¼ºåº¦ (lux)'
              }
            }
          }
        }
      });
    }
    
    function calculateStatistics(sensorData) {
      const stats = {
        temperature: calculateStat(sensorData, 'temperature'),
        humidity: calculateStat(sensorData, 'humidity'),
        soilMoisture: calculateStat(sensorData, 'soil_moisture'),
        ph: calculateStat(sensorData, 'ph_value')
      };
      
      document.getElementById('tempStats').innerHTML = 
        `å¹³å‡: ${stats.temperature.avg}Â°C<br>èŒƒå›´: ${stats.temperature.min}Â°C - ${stats.temperature.max}Â°C`;
      document.getElementById('humidityStats').innerHTML = 
        `å¹³å‡: ${stats.humidity.avg}%<br>èŒƒå›´: ${stats.humidity.min}% - ${stats.humidity.max}%`;
      document.getElementById('soilMoistureStats').innerHTML = 
        `å¹³å‡: ${stats.soilMoisture.avg}%<br>èŒƒå›´: ${stats.soilMoisture.min}% - ${stats.soilMoisture.max}%`;
      document.getElementById('phStats').innerHTML = 
        `å¹³å‡: ${stats.ph.avg}<br>èŒƒå›´: ${stats.ph.min} - ${stats.ph.max}`;
    }
    
    function calculateStat(data, field) {
      const values = data.map(item => parseFloat(item[field])).filter(v => !isNaN(v));
      if (values.length === 0) {
        return { avg: '--', min: '--', max: '--' };
      }
      
      const sum = values.reduce((a, b) => a + b, 0);
      const avg = (sum / values.length).toFixed(1);
      const min = Math.min(...values).toFixed(1);
      const max = Math.max(...values).toFixed(1);
      
      return { avg, min, max };
    }
    
    function refreshCharts() {
      loadChartData();
    }
    
    function generateDemoData() {
      const fieldId = document.getElementById('chartFieldSelect').value;
      
      if (!fieldId) {
        alert('è¯·å…ˆé€‰æ‹©åœ°å—');
        return;
      }
      
      if (!confirm('ç¡®å®šè¦ä¸ºè¯¥åœ°å—ç”Ÿæˆæ¼”ç¤ºæ•°æ®å—ï¼Ÿè¿™å°†æ·»åŠ 7å¤©çš„æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®ã€‚')) {
        return;
      }
      
      document.getElementById('chartLoadingMessage').innerHTML = 
        '<p><span class="loading-spinner"></span> æ­£åœ¨ç”Ÿæˆæ¼”ç¤ºæ•°æ®...</p>';
      document.getElementById('chartLoadingMessage').style.display = 'block';
      
      fetch('/api/generate_demo_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          field_id: parseInt(fieldId),
          days: 7
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('chartLoadingMessage').innerHTML = 
              `<p style="color: #28a745;">âœ… ${data.message}</p>`;
            // è‡ªåŠ¨åŠ è½½å›¾è¡¨
            setTimeout(() => {
              loadChartData();
            }, 1000);
          } else {
            document.getElementById('chartLoadingMessage').innerHTML = 
              `<p style="color: #d32f2f;">âŒ ç”Ÿæˆå¤±è´¥: ${data.message}</p>`;
          }
        })
        .catch(error => {
          console.error('ç”Ÿæˆæ¼”ç¤ºæ•°æ®å¤±è´¥:', error);
          document.getElementById('chartLoadingMessage').innerHTML = 
            '<p style="color: #d32f2f;">âŒ ç”Ÿæˆæ¼”ç¤ºæ•°æ®å¤±è´¥</p>';
        });
    }

    // å¼‚å¸¸æ£€æµ‹ä¸é¢„è­¦ç›¸å…³å‡½æ•°
    let autoCheckInterval = null;
    
    function checkFieldAlerts() {
      const fieldId = document.getElementById('alertFieldSelect').value;
      
      if (!fieldId) {
        updateAlertStatus('error', 'âŒ', 'è¯·é€‰æ‹©åœ°å—', 'è¯·å…ˆé€‰æ‹©è¦æ£€æŸ¥çš„åœ°å—');
        return;
      }
      
      updateAlertStatus('loading', 'ğŸ”', 'æ£€æŸ¥ä¸­...', 'æ­£åœ¨åˆ†æä¼ æ„Ÿå™¨æ•°æ®...');
      
      fetch(`/api/check_field_alerts?field_id=${fieldId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            displayAlertResults(data);
          } else if (data.status === 'no_data') {
            updateAlertStatus('info', 'â„¹ï¸', 'æ— æ•°æ®', data.message);
            document.getElementById('alertDetails').innerHTML = 
              '<p style="color: #999; text-align: center; padding: 20px;">è¯¥åœ°å—æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæ— æ³•è¿›è¡Œå¼‚å¸¸æ£€æµ‹</p>';
            document.getElementById('alertRecommendations').innerHTML = 
              '<div class="recommendation-item">å»ºè®®å…ˆå½•å…¥ä¸€äº›ä¼ æ„Ÿå™¨æ•°æ®æˆ–ç”Ÿæˆæ¼”ç¤ºæ•°æ®</div>';
          } else {
            updateAlertStatus('error', 'âŒ', 'æ£€æŸ¥å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
          }
        })
        .catch(error => {
          console.error('æ£€æŸ¥é¢„è­¦å¤±è´¥:', error);
          updateAlertStatus('error', 'âŒ', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        });
    }
    
    function displayAlertResults(data) {
      const summary = data.alert_summary;
      const anomalies = data.all_anomalies || [];
      
      // æ›´æ–°çŠ¶æ€å¡ç‰‡
      const level = summary.max_level;
      const icon = summary.alert_info.icon;
      const statusText = summary.total_alerts === 0 ? 'æ­£å¸¸' : `${summary.total_alerts}ä¸ªå¼‚å¸¸`;
      
      updateAlertStatus(level, icon, statusText, summary.summary);
      
      // æ˜¾ç¤ºè¯¦ç»†å¼‚å¸¸ä¿¡æ¯
      displayAlertDetails(anomalies);
      
      // æ˜¾ç¤ºå¤„ç†å»ºè®®
      displayRecommendations(summary.recommendations);
    }
    
    function updateAlertStatus(level, icon, title, message) {
      const statusCard = document.getElementById('alertStatusCard');
      const statusIcon = statusCard.querySelector('.status-icon');
      const statusTitle = statusCard.querySelector('.status-text h4');
      const statusMessage = statusCard.querySelector('.status-text p');
      
      // ç§»é™¤æ‰€æœ‰ç­‰çº§ç±»
      statusCard.className = 'alert-status-card';
      if (level !== 'loading' && level !== 'error') {
        statusCard.classList.add(level);
      }
      
      statusIcon.textContent = icon;
      statusTitle.textContent = title;
      statusMessage.textContent = message;
    }
    
    function displayAlertDetails(anomalies) {
      const detailsContainer = document.getElementById('alertDetails');
      
      if (anomalies.length === 0) {
        detailsContainer.innerHTML = 
          '<p style="color: #28a745; text-align: center; padding: 20px;">âœ… æ‰€æœ‰å‚æ•°æ­£å¸¸ï¼Œæœªå‘ç°å¼‚å¸¸</p>';
        return;
      }
      
      let html = '';
      anomalies.forEach(anomaly => {
        const level = anomaly.level || 'info';
        const icon = getAlertIcon(level);
        const parameterName = getParameterDisplayName(anomaly.parameter);
        
        html += `
          <div class="alert-item ${level}">
            <div class="alert-icon">${icon}</div>
            <div class="alert-content">
              <h5>${parameterName}</h5>
              <p>${anomaly.message}</p>
              ${anomaly.value !== undefined ? `<span class="alert-value">å½“å‰å€¼: ${anomaly.value}</span>` : ''}
            </div>
          </div>
        `;
      });
      
      detailsContainer.innerHTML = html;
    }
    
    function displayRecommendations(recommendations) {
      const recommendationsContainer = document.getElementById('alertRecommendations');
      
      if (!recommendations || recommendations.length === 0) {
        recommendationsContainer.innerHTML = 
          '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— ç‰¹æ®Šå»ºè®®</p>';
        return;
      }
      
      let html = '';
      recommendations.forEach(recommendation => {
        if (recommendation.trim()) {
          html += `<div class="recommendation-item">ğŸ’¡ ${recommendation}</div>`;
        }
      });
      
      recommendationsContainer.innerHTML = html || 
        '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— ç‰¹æ®Šå»ºè®®</p>';
    }
    
    function getAlertIcon(level) {
      const icons = {
        'info': 'â„¹ï¸',
        'warning': 'âš ï¸',
        'danger': 'ğŸš¨',
        'critical': 'ğŸ’€'
      };
      return icons[level] || 'â„¹ï¸';
    }
    
    function getParameterDisplayName(parameter) {
      const names = {
        'temperature': 'æ¸©åº¦',
        'humidity': 'æ¹¿åº¦',
        'soil_moisture': 'åœŸå£¤æ¹¿åº¦',
        'ph_value': 'pHå€¼',
        'light_intensity': 'å…‰ç…§å¼ºåº¦',
        'nitrogen': 'æ°®å«é‡',
        'phosphorus': 'ç£·å«é‡',
        'potassium': 'é’¾å«é‡'
      };
      return names[parameter] || parameter;
    }
    
    function enableAutoCheck() {
      const btn = document.getElementById('autoCheckBtn');
      
      if (autoCheckInterval) {
        // åœæ­¢è‡ªåŠ¨æ£€æŸ¥
        clearInterval(autoCheckInterval);
        autoCheckInterval = null;
        btn.textContent = 'ğŸ”„ å¯ç”¨è‡ªåŠ¨æ£€æµ‹';
        btn.style.background = '#2196f3';
      } else {
        // å¯åŠ¨è‡ªåŠ¨æ£€æŸ¥
        const fieldId = document.getElementById('alertFieldSelect').value;
        if (!fieldId) {
          alert('è¯·å…ˆé€‰æ‹©åœ°å—');
          return;
        }
        
        autoCheckInterval = setInterval(() => {
          checkFieldAlerts();
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        
        btn.textContent = 'â¹ï¸ åœæ­¢è‡ªåŠ¨æ£€æµ‹';
        btn.style.background = '#dc3545';
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
        checkFieldAlerts();
      }
    }
    
    function refreshAlerts() {
      checkFieldAlerts();
    }
    
    // åœ¨ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜åè‡ªåŠ¨æ£€æŸ¥å¼‚å¸¸
    function saveSensorDataWithAlert() {
      const fieldId = document.getElementById('sensorFieldSelect').value;
      if (!fieldId) {
        document.getElementById('sensorResult').innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©åœ°å—</div>';
        return;
      }

      const data = {
        field_id: parseInt(fieldId),
        crop_type: document.getElementById('sensorCropSelect').value,
        growth_stage: document.getElementById('sensorStageSelect').value,
        temperature: document.getElementById('temperature').value || null,
        humidity: document.getElementById('humidity').value || null,
        soil_moisture: document.getElementById('soilMoisture').value || null,
        light_intensity: document.getElementById('lightIntensity').value || null,
        ph_value: document.getElementById('phValue').value || null,
        nitrogen: document.getElementById('nitrogen').value || null,
        phosphorus: document.getElementById('phosphorus').value || null,
        potassium: document.getElementById('potassium').value || null,
        location: document.getElementById('location').value || null
      };

      fetch('/api/save_sensor_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.status === 'success') {
            document.getElementById('sensorResult').innerHTML = 
              '<div class="success">ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜æˆåŠŸï¼ID: ' + result.data_id + '</div>';
            
            // è‡ªåŠ¨æ£€æŸ¥å¼‚å¸¸
            checkSensorDataAnomalies(data);
          } else {
            document.getElementById('sensorResult').innerHTML = 
              '<div class="error">ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
          }
        })
        .catch(error => {
          console.error('é”™è¯¯:', error);
          document.getElementById('sensorResult').innerHTML = 
            '<div class="error">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</div>';
        });
    }
    
    function checkSensorDataAnomalies(sensorData) {
      const cropType = sensorData.crop_type || 'æ°´ç¨»';
      
      fetch('/api/check_sensor_anomalies', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          sensor_data: sensorData,
          crop_type: cropType
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.anomalies.length > 0) {
            const summary = data.alert_summary;
            const alertHtml = `
              <div class="alert-item ${summary.max_level}" style="margin-top: 10px;">
                <div class="alert-icon">${getAlertIcon(summary.max_level)}</div>
                <div class="alert-content">
                  <h5>å¼‚å¸¸æ£€æµ‹ç»“æœ</h5>
                  <p>${summary.summary}</p>
                </div>
              </div>
            `;
            document.getElementById('sensorResult').innerHTML += alertHtml;
          }
        })
        .catch(error => {
          console.error('å¼‚å¸¸æ£€æµ‹å¤±è´¥:', error);
        });
    }

    // é¡µé¢åŠ è½½æ—¶å…ˆæ‹‰å–ç”¨æˆ·ï¼Œå†åŠ è½½åœ°å—
    window.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</body>
</html>

